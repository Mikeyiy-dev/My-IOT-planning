<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShadowFox - Modern Dashboard</title>
    
    <!-- Icon & Font -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- TH∆Ø VI·ªÜN MQTT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #e0e7ff;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-light: #9ca3af;
            --sidebar-w: 260px;
            --radius: 20px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* DARK MODE */
        body.dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-light: #94a3b8;
            --primary-light: #312e81;
            --secondary: #94a3b8;
        }
        body.dark-mode .sidebar, body.dark-mode .content-container {
            background: rgba(30, 41, 59, 0.95);
            border-color: rgba(255,255,255,0.1);
        }
        body.dark-mode .menu-item:hover { background: #334155; }
        body.dark-mode .card, body.dark-mode .input-modern, body.dark-mode .modern-table th, body.dark-mode .modern-table td {
            border-color: #334155;
        }
        body.dark-mode .upload-zone { background: #1e293b; border-color: #475569; }
        body.dark-mode .pump-card:hover { background: #334155; }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        
        body { 
            background-color: var(--bg-body); 
            background-image: url('https://images.unsplash.com/photo-1493246507139-91e8fad9978e?q=80&w=2670&auto=format&fit=crop');
            background-size: cover; background-position: center; background-attachment: fixed;
            display: flex; min-height: 100vh; color: var(--text-main);
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-w);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            height: 96vh; margin: 2vh; 
            border-radius: var(--radius);
            display: flex; flex-direction: column;
            box-shadow: var(--shadow);
            z-index: 100; border: 1px solid rgba(255,255,255,0.5);
        }
        
        .logo-box {
            padding: 25px 20px; display: flex; align-items: center; gap: 12px;
            border-bottom: 1px solid var(--primary-light);
        }
        .logo-img { width: 45px; height: auto; max-height: 45px; object-fit: contain; }
        .logo-text h3 { font-size: 18px; font-weight: 700; color: var(--text-main); margin: 0; }
        .logo-text span { font-size: 12px; color: var(--text-light); }

        .menu { list-style: none; padding: 20px; flex: 1; }
        .menu-item {
            padding: 14px 16px; margin-bottom: 8px; border-radius: 12px;
            display: flex; align-items: center; gap: 14px; color: var(--secondary);
            cursor: pointer; transition: 0.2s; font-weight: 500; font-size: 15px;
        }
        .menu-item:hover { background: #f8fafc; color: var(--primary); }
        .menu-item.active { 
            background: var(--primary); color: white; font-weight: 600;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        .menu-item i { font-size: 22px; }

        .user-footer {
            padding: 20px; border-top: 1px solid #f1f5f9;
            display: flex; align-items: center; gap: 12px; cursor: pointer;
            transition: 0.2s;
        }
        .user-footer:hover { background: var(--primary-light); border-radius: 0 0 var(--radius) var(--radius); }
        .user-avatar { 
            width: 40px; height: 40px; border-radius: 10px; object-fit: contain;
            background: #f1f5f9; padding: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- MAIN CONTENT --- */
        .main { flex: 1; padding: 2vh 2vh 2vh 0; overflow-y: auto; height: 100vh; }
        
        .content-container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            border-radius: var(--radius);
            min-height: 96vh; padding: 30px;
            box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.5);
            display: flex; flex-direction: column;
        }

        /* HEADER */
        .top-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; padding-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .greeting h2 { margin: 0; font-size: 24px; color: var(--text-main); }
        .date-display { color: var(--text-light); font-size: 14px; margin-top: 5px; font-weight: 500; }
        .clock-display {
            font-size: 32px; font-weight: 700; color: var(--primary);
            font-variant-numeric: tabular-nums;
            background: rgba(255,255,255,0.5); padding: 5px 20px; border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* IOT STATUS */
        .iot-status {
            font-size: 12px; padding: 5px 10px; border-radius: 20px; background: #eee; color: #666;
            display: inline-flex; align-items: center; gap: 5px; margin-top: 5px;
        }
        .iot-status.connected { background: #d1fae5; color: #065f46; }
        .iot-dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
        .iot-status.connected .iot-dot { background: #10b981; box-shadow: 0 0 5px #10b981; }

        /* TABS */
        .tab-content { display: none; animation: fadeIn 0.4s ease; flex: 1; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* GRID LAYOUTS */
        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }

        /* CARDS */
        .card {
            background: var(--bg-card); border-radius: 16px; padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #e2e8f0;
            margin-bottom: 25px; position: relative; overflow: hidden;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .card-title i { color: var(--primary); font-size: 20px; }

        /* WIDGETS */
        .camera-container {
            width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px;
            overflow: hidden; position: relative;
        }
        .camera-container img { width: 100%; height: 100%; object-fit: cover; }
        .live-badge {
            position: absolute; top: 12px; left: 12px;
            background: rgba(239, 68, 68, 0.9); color: white; padding: 4px 10px;
            border-radius: 6px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px;
            display: flex; align-items: center; gap: 6px;
        }
        .live-badge::before { content:''; width: 6px; height: 6px; background: white; border-radius: 50%; }

        .pump-card {
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
            padding: 40px 20px; transition: 0.3s; cursor: pointer; border: 2px solid transparent;
        }
        .pump-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .pump-icon {
            width: 70px; height: 70px; background: var(--primary-light); color: var(--primary);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 32px; margin-bottom: 15px; transition: 0.3s;
        }
        .pump-card.active { border-color: var(--primary); background: #f0f7ff; }
        .pump-card.active .pump-icon { background: var(--primary); color: white; box-shadow: 0 0 15px rgba(79, 70, 229, 0.4); }

        .stat-value { font-size: 36px; font-weight: 700; color: var(--text-main); margin: 10px 0; }
        .alert-box {
            padding: 15px; border-radius: 12px; background: #ecfdf5; color: var(--success);
            font-weight: 600; font-size: 14px; text-align: center; border: 1px solid #d1fae5;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .alert-box.danger { background: #fef2f2; color: var(--danger); border-color: #fee2e2; }

        .avatar-grid { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px; }
        .avatar-item {
            width: 70px; height: 70px; border-radius: 50%; padding: 10px; border: 3px solid #e2e8f0;
            cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; background: #fff;
        }
        .avatar-item img { width: 100%; height: 100%; object-fit: contain; }
        .avatar-item:hover, .avatar-item.selected { border-color: var(--primary); transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        .input-modern { width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; margin-top: 10px; outline: none; transition: 0.2s; background: var(--bg-card); color: var(--text-main); }
        .input-modern:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

        .btn { padding: 12px 24px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; width: 100%; margin-top: 15px; }
        .btn-primary:hover { background: #4338ca; }
        .btn-danger { background: #fee2e2; color: var(--danger); width: 100%; margin-top: 10px; }
        .btn-danger:hover { background: #fecaca; }

        .upload-zone { 
            display: block; border: 2px dashed #cbd5e1; border-radius: 12px; padding: 40px; text-align: center; 
            cursor: pointer; color: var(--secondary); transition: 0.3s; background: var(--bg-card); 
        }
        .upload-zone:hover { border-color: var(--primary); background: var(--primary-light); }

        .modern-table { width: 100%; border-collapse: collapse; }
        .modern-table th { text-align: left; padding: 16px; color: var(--text-light); font-weight: 600; border-bottom: 1px solid #e2e8f0; font-size: 13px; text-transform: uppercase; }
        .modern-table td { padding: 16px; border-bottom: 1px solid #f1f5f9; color: var(--text-main); font-size: 14px; }
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .tag.ok { background: #ecfdf5; color: var(--success); }
        .tag.warn { background: #fffbeb; color: var(--warning); }
        .tag.err { background: #fef2f2; color: var(--danger); }

        .setting-section { margin-bottom: 30px; }
        .setting-title { font-size: 13px; font-weight: 700; color: var(--text-light); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f5f9; }
        .setting-info h4 { font-size: 15px; font-weight: 600; margin: 0 0 5px 0; color: var(--text-main); }
        .setting-info p { font-size: 13px; color: var(--text-light); margin: 0; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }
        .form-select { padding: 10px 15px; border-radius: 10px; border: 1px solid #e2e8f0; outline: none; color: var(--text-main); font-family: 'Inter'; font-size: 14px; background-color: var(--bg-card); cursor: pointer; }

        @media (max-width: 1024px) {
            .sidebar { width: 80px; } .logo-text, .menu-item span, .user-footer div { display: none; }
            .menu-item { justify-content: center; padding: 14px; } .logo-box { justify-content: center; padding: 30px 0; }
            .dashboard-grid { grid-template-columns: 1fr; } .top-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .clock-display { font-size: 24px; align-self: flex-end; }
        }
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: auto; height: auto; margin: 0; border-radius: 0; flex-direction: row; justify-content: space-between; padding: 10px; }
            .menu { display: flex; padding: 0; } .main { padding: 0; height: auto; } .content-container { border-radius: 0; border: none; padding: 20px; }
        }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo-box">
            <img src="logo.png" alt="Logo" class="logo-img">
            <div class="logo-text">
                <h3>ShadowFox</h3>
                <span>IoT System</span>
            </div>
        </div>

        <ul class="menu">
            <li class="menu-item active" onclick="switchTab('home', this)">
                <i class='bx bx-grid-alt'></i> <span data-i18n="menu.home">T·ªïng quan</span>
            </li>
            <li class="menu-item" onclick="switchTab('camera', this)">
                <i class='bx bx-cctv'></i> <span data-i18n="menu.camera">Camera</span>
            </li>
            <li class="menu-item" onclick="switchTab('logs', this)">
                <i class='bx bx-list-ul'></i> <span data-i18n="menu.logs">Nh·∫≠t k√Ω</span>
            </li>
            <li class="menu-item" onclick="switchTab('account', this)">
                <i class='bx bx-user'></i> <span data-i18n="menu.account">T√†i kho·∫£n</span>
            </li>
            <li class="menu-item" onclick="switchTab('settings', this)">
                <i class='bx bx-cog'></i> <span data-i18n="menu.settings">C√†i ƒë·∫∑t</span>
            </li>
        </ul>

        <div class="user-footer" onclick="switchTab('account', null)">
            <img src="https://cdn-icons-png.flaticon.com/512/616/616408.png" class="user-avatar" id="sidebarAvatar">
            <div>
                <div style="font-weight: 600; font-size: 14px;" id="sidebarName">Judy Hopps</div>
                <div style="font-size: 12px; color: #9ca3af;">Admin</div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main">
        <div class="content-container">
            
            <!-- HEADER -->
            <div class="top-header">
                <div class="greeting">
                    <h2><span data-i18n="header.hello">Xin ch√†o</span>, <span id="headerName" style="color: var(--primary);">Judy</span>! üëã</h2>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <p class="date-display" id="dateDisplay">...</p>
                        <div class="iot-status" id="mqttStatus"><div class="iot-dot"></div> <span id="mqttText" data-i18n="iot.disconnected">Ng·∫Øt k·∫øt n·ªëi</span></div>
                    </div>
                </div>
                <div class="clock-display" id="clockDisplay">00:00:00</div>
            </div>

            <!-- TAB 1: DASHBOARD -->
            <div id="tab-home" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="left-col">
                        <div class="card" style="padding: 0; border: none; overflow: hidden;">
                            <div class="camera-container">
                                <div class="live-badge">‚óè LIVE</div>
                                <!-- THAY IP CAMERA C·ª¶A B·∫†N V√ÄO ƒê√ÇY -->
                                <img id="camStream1" src="https://images.unsplash.com/photo-1518386377785-132b4b443213?q=80&w=2670&auto=format&fit=crop">
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header"><span class="card-title"><i class='bx bx-line-chart'></i> <span data-i18n="chart.title">Bi·ªÉu ƒë·ªì m·ª±c n∆∞·ªõc</span></span></div>
                            <div id="lineChart" style="min-height: 250px;"></div>
                        </div>
                    </div>
                    <div class="right-col">
                        <div class="card" style="text-align: center;">
                            <div class="card-title" style="justify-content: center; margin-bottom: 5px;" data-i18n="gauge.title">M·ª±c n∆∞·ªõc hi·ªán t·∫°i</div>
                            <div id="gaugeChart" style="margin-top: -15px;"></div>
                            <div class="stat-value" id="waterLevelText" style="color: var(--primary);">0%</div>
                            <div id="statusAlert" class="alert-box"><i class='bx bx-loader-alt bx-spin'></i> <span data-i18n="status.waiting">ƒêang ƒë·ª£i d·ªØ li·ªáu...</span></div>
                        </div>
                        <div class="card">
                            <div class="card-title" data-i18n="controls.title">ƒêi·ªÅu khi·ªÉn</div>
                            <div id="btnPump" class="pump-card" onclick="togglePump()">
                                <div class="pump-icon"><i class='bx bx-water'></i></div>
                                <div><div style="font-weight: 600;" data-i18n="pump.name">M√°y B∆°m</div><div style="font-size: 12px; color: var(--text-light);" id="pumpText">OFF</div></div>
                            </div>
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #f1f5f9;">
                                <div style="display: flex; justify-content: space-between; font-size: 13px; color: var(--secondary);">
                                    <span data-i18n="siren.label">Tr·∫°ng th√°i C√≤i h√∫:</span><span style="font-weight: 600;" id="sirenText">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OTHER TABS -->
            <div id="tab-camera" class="tab-content">
                <div class="card" style="height: 75vh; padding: 0; overflow: hidden; background: #000;">
                    <div class="camera-container" style="height: 100%; border-radius: 0;">
                        <img id="camStream2" src="https://images.unsplash.com/photo-1518386377785-132b4b443213?q=80&w=2670&auto=format&fit=crop">
                    </div>
                </div>
            </div>

            <div id="tab-logs" class="tab-content">
                <div class="card">
                    <div class="card-header"><span class="card-title"><i class='bx bx-history'></i> <span data-i18n="logs.title">Nh·∫≠t k√Ω ho·∫°t ƒë·ªông</span></span>
                    <button class="btn" style="border: 1px solid #e2e8f0; padding: 8px 16px;">Export CSV</button></div>
                    <table class="modern-table">
                        <thead><tr>
                            <th data-i18n="table.time">Th·ªùi gian</th>
                            <th data-i18n="table.event">S·ª± ki·ªán</th>
                            <th data-i18n="table.detail">Chi ti·∫øt</th>
                            <th data-i18n="table.status">Tr·∫°ng th√°i</th>
                        </tr></thead><tbody id="logBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-account" class="tab-content">
                <div class="card" style="max-width: 500px; margin: 0 auto;">
                    <div class="card-header"><span class="card-title"><i class='bx bx-id-card'></i> <span data-i18n="account.title">Th√¥ng tin t√†i kho·∫£n</span></span></div>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img id="previewAvatar" src="https://cdn-icons-png.flaticon.com/512/616/616408.png" style="width: 100px; height: 100px; border-radius: 50%; object-fit: contain; border: 4px solid var(--primary-light); background: #f8fafc; padding: 10px;">
                        <h2 style="margin-top: 10px;" id="previewName">Judy Hopps</h2>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="font-size: 13px; font-weight: 600; color: var(--secondary);" data-i18n="account.choose_avatar">Ch·ªçn nh√¢n v·∫≠t ƒë·∫°i di·ªán:</label>
                        <div class="avatar-grid">
                            <div class="avatar-item selected" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/616/616408.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/616/616408.png"></div>
                            <div class="avatar-item" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/616/616432.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/616/616432.png"></div>
                            <div class="avatar-item" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/3069/3069172.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/3069/3069172.png"></div>
                            <div class="avatar-item" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/616/616430.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/616/616430.png"></div>
                            <div class="avatar-item" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/2298/2298263.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/2298/2298263.png"></div>
                            <div class="avatar-item" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/616/616487.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/616/616487.png"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="font-size: 13px; font-weight: 600; color: var(--secondary);" data-i18n="account.display_name">T√™n hi·ªÉn th·ªã:</label>
                        <input type="text" id="nameInput" class="input-modern" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n">
                    </div>
                    <button class="btn btn-primary" onclick="saveProfile()" data-i18n="btn.save">L∆∞u thay ƒë·ªïi</button>
                    <button class="btn btn-danger" onclick="logout()" data-i18n="btn.logout">ƒêƒÉng xu·∫•t</button>
                </div>
            </div>

            <!-- SETTINGS TAB -->
            <div id="tab-settings" class="tab-content">
                <div class="card" style="max-width: 650px; margin: 0 auto;">
                    <div class="card-header"><span class="card-title"><i class='bx bx-cog'></i> <span data-i18n="settings.title">C√†i ƒë·∫∑t h·ªá th·ªëng</span></span></div>
                    
                    <div class="setting-section">
                        <div class="setting-title" data-i18n="settings.interface">Giao di·ªán</div>
                        <div class="setting-row">
                            <div class="setting-info"><h4 data-i18n="settings.language">Ng√¥n ng·ªØ</h4><p data-i18n="settings.language_desc">Ch·ªçn ng√¥n ng·ªØ hi·ªÉn th·ªã.</p></div>
                            <select class="form-select" id="langSelect" onchange="changeLanguage(this.value)">
                                <option value="vi">Ti·∫øng Vi·ªát</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info"><h4 data-i18n="settings.dark_mode">Ch·∫ø ƒë·ªô T·ªëi (Dark Mode)</h4><p data-i18n="settings.dark_mode_desc">Giao di·ªán t·ªëi b·∫£o v·ªá m·∫Øt.</p></div>
                            <label class="switch"><input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()"><span class="slider"></span></label>
                        </div>
                        <div class="setting-row" style="display: block;">
                            <div class="setting-info" style="margin-bottom: 10px;"><h4 data-i18n="settings.wallpaper">H√¨nh n·ªÅn Dashboard</h4><p data-i18n="settings.wallpaper_desc">T·∫£i ·∫£nh t·ª´ m√°y t√≠nh (Max 5MB).</p></div>
                            <input type="file" id="bgUpload" hidden onchange="changeBg(event)">
                            <label for="bgUpload" class="upload-zone">
                                <i class='bx bx-cloud-upload' style="font-size: 40px; color: var(--primary);"></i>
                                <div style="margin-top: 10px; font-weight: 600;" data-i18n="upload.click">Nh·∫•n ƒë·ªÉ t·∫£i ·∫£nh l√™n</div>
                            </label>
                            <button class="btn" style="width: 100%; margin-top: 10px; background: #f1f5f9; color: var(--secondary);" onclick="resetBg()" data-i18n="btn.default">V·ªÅ m·∫∑c ƒë·ªãnh</button>
                        </div>
                    </div>

                    <div class="setting-section">
                        <div class="setting-title" data-i18n="settings.notification">Th√¥ng b√°o</div>
                        <div class="setting-row">
                            <div class="setting-info"><h4 data-i18n="settings.sound">C·∫£nh b√°o √¢m thanh</h4><p data-i18n="settings.sound_desc">Ph√°t ti·∫øng khi c√≥ s·ª± c·ªë.</p></div>
                            <label class="switch"><input type="checkbox" onchange="saveSetting('sound', this.checked)"><span class="slider"></span></label>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- 1. BI·∫æN TO√ÄN C·ª§C (ƒê∆ØA L√äN ƒê·∫¶U ƒê·ªÇ TR√ÅNH L·ªñI REFERENCE) ---
        let lastLevel = 0;
        let lastPump = false;
        let lastSiren = false;
        let historyData = [20, 20, 20, 20, 20];
        let client = null; // Khai b√°o client ·ªü ƒë√¢y

        // --- 2. H·ªÜ TH·ªêNG NG√îN NG·ªÆ ---
        const translations = {
            vi: {
                "menu.home": "T·ªïng quan", "menu.camera": "Camera", "menu.logs": "Nh·∫≠t k√Ω", "menu.account": "T√†i kho·∫£n", "menu.settings": "C√†i ƒë·∫∑t",
                "header.hello": "Xin ch√†o", "iot.connected": "ƒê√£ k·∫øt n·ªëi IoT", "iot.disconnected": "Ng·∫Øt k·∫øt n·ªëi",
                "chart.title": "Bi·ªÉu ƒë·ªì m·ª±c n∆∞·ªõc", "gauge.title": "M·ª±c n∆∞·ªõc hi·ªán t·∫°i", "status.waiting": "ƒêang ƒë·ª£i d·ªØ li·ªáu...", "status.safe": "H·ªá th·ªëng an to√†n", "status.danger": "C·∫¢NH B√ÅO NG·∫¨P!",
                "controls.title": "ƒêi·ªÅu khi·ªÉn", "pump.name": "M√°y B∆°m", "pump.on": "ƒêang Ho·∫°t ƒê·ªông", "pump.off": "ƒêang T·∫Øt", "siren.label": "Tr·∫°ng th√°i C√≤i h√∫:", "siren.on": "ƒêANG H√ö C√íI", "siren.off": "Im l·∫∑ng",
                "logs.title": "Nh·∫≠t k√Ω ho·∫°t ƒë·ªông", "table.time": "Th·ªùi gian", "table.event": "S·ª± ki·ªán", "table.detail": "Chi ti·∫øt", "table.status": "Tr·∫°ng th√°i",
                "account.title": "Th√¥ng tin t√†i kho·∫£n", "account.choose_avatar": "Ch·ªçn nh√¢n v·∫≠t ƒë·∫°i di·ªán:", "account.display_name": "T√™n hi·ªÉn th·ªã:",
                "settings.title": "C√†i ƒë·∫∑t h·ªá th·ªëng", "settings.interface": "Giao di·ªán", "settings.language": "Ng√¥n ng·ªØ", "settings.language_desc": "Ch·ªçn ng√¥n ng·ªØ hi·ªÉn th·ªã.",
                "settings.dark_mode": "Ch·∫ø ƒë·ªô T·ªëi", "settings.dark_mode_desc": "Chuy·ªÉn sang giao di·ªán t·ªëi.", "settings.wallpaper": "H√¨nh n·ªÅn", "settings.wallpaper_desc": "T·∫£i ·∫£nh t·ª´ m√°y t√≠nh (Max 5MB).",
                "settings.notification": "Th√¥ng b√°o", "settings.sound": "C·∫£nh b√°o √¢m thanh", "settings.sound_desc": "Ph√°t ti·∫øng khi c√≥ s·ª± c·ªë.",
                "btn.save": "L∆∞u thay ƒë·ªïi", "btn.logout": "ƒêƒÉng xu·∫•t", "btn.default": "V·ªÅ m·∫∑c ƒë·ªãnh", "upload.click": "Nh·∫•n ƒë·ªÉ t·∫£i ·∫£nh l√™n", "upload.done": "ƒê√£ t·∫£i ·∫£nh l√™n!"
            },
            en: {
                "menu.home": "Overview", "menu.camera": "Camera", "menu.logs": "Logs", "menu.account": "Account", "menu.settings": "Settings",
                "header.hello": "Hello", "iot.connected": "IoT Connected", "iot.disconnected": "Disconnected",
                "chart.title": "Water Level Chart", "gauge.title": "Current Level", "status.waiting": "Waiting for data...", "status.safe": "System Safe", "status.danger": "FLOOD ALERT!",
                "controls.title": "Controls", "pump.name": "Water Pump", "pump.on": "Running", "pump.off": "Stopped", "siren.label": "Siren Status:", "siren.on": "SIREN ON", "siren.off": "Silent",
                "logs.title": "Activity Logs", "table.time": "Time", "table.event": "Event", "table.detail": "Detail", "table.status": "Status",
                "account.title": "Account Info", "account.choose_avatar": "Choose Avatar:", "account.display_name": "Display Name:",
                "settings.title": "System Settings", "settings.interface": "Interface", "settings.language": "Language", "settings.language_desc": "Select display language.",
                "settings.dark_mode": "Dark Mode", "settings.dark_mode_desc": "Switch to dark theme.", "settings.wallpaper": "Wallpaper", "settings.wallpaper_desc": "Upload image (Max 5MB).",
                "settings.notification": "Notifications", "settings.sound": "Sound Alert", "settings.sound_desc": "Play sound on alert.",
                "btn.save": "Save Changes", "btn.logout": "Logout", "btn.default": "Reset Default", "upload.click": "Click to upload", "upload.done": "Image Uploaded!"
            }
        };

        let currentLang = localStorage.getItem('lang') || 'vi';
        document.getElementById('langSelect').value = currentLang;

        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.innerText = translations[lang][key];
            });
            // Update dynamic text immediately
            updateDashboardText();
        }
        
        // --- 3. CLOCK & DATE ---
        function updateTime() {
            const now = new Date();
            document.getElementById('clockDisplay').innerText = now.toLocaleTimeString(currentLang === 'vi' ? 'vi-VN' : 'en-US', {hour12: false});
            const options = { weekday: 'long', year: 'numeric', month: '2-digit', day: '2-digit' };
            const dateStr = now.toLocaleDateString(currentLang === 'vi' ? 'vi-VN' : 'en-US', options);
            document.getElementById('dateDisplay').innerText = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
        }
        
        // --- 4. UI LOGIC & CHARTS ---
        let currentUser = localStorage.getItem('currentUser') || "Judy Hopps";
        let currentAvatar = localStorage.getItem('currentAvatar') || "https://cdn-icons-png.flaticon.com/512/616/616408.png";
        updateProfileUI(currentUser, currentAvatar);
        const savedBg = localStorage.getItem('modern_bg');
        if(savedBg) document.body.style.backgroundImage = `url('${savedBg}')`;
        const isDark = localStorage.getItem('darkMode') === 'true';
        if(isDark) { document.body.classList.add('dark-mode'); document.getElementById('darkModeToggle').checked = true; }

        function updateProfileUI(name, avatar) {
            document.getElementById('sidebarName').innerText = name;
            document.getElementById('headerName').innerText = name;
            document.getElementById('sidebarAvatar').src = avatar;
            document.getElementById('previewName').innerText = name;
            document.getElementById('previewAvatar').src = avatar;
            document.getElementById('nameInput').value = name;
        }

        // Charts
        var chartOptions = {
            series: [{ name: 'Water', data: [] }],
            chart: { type: 'area', height: 250, toolbar: { show: false }, fontFamily: 'Inter', animations: { enabled: false }, background: 'transparent' },
            colors: ['#4f46e5'], stroke: { curve: 'smooth', width: 2 },
            fill: { type: 'gradient', gradient: { opacityFrom: 0.4, opacityTo: 0.05 } },
            dataLabels: { enabled: false }, xaxis: { labels: { show: false } }, yaxis: { max: 100, min: 0 },
            theme: { mode: isDark ? 'dark' : 'light' }
        };
        var lineChart = new ApexCharts(document.querySelector("#lineChart"), chartOptions);
        lineChart.render();

        var gaugeOptions = {
            series: [0], chart: { height: 250, type: 'radialBar', fontFamily: 'Inter' },
            plotOptions: { radialBar: { hollow: { size: '60%' }, track: { background: isDark ? '#334155' : '#f1f5f9' }, dataLabels: { show: false } } },
            colors: ['#4f46e5'], stroke: { lineCap: 'round' }
        };
        var gaugeChart = new ApexCharts(document.querySelector("#gaugeChart"), gaugeOptions);
        gaugeChart.render();

        // Update UI Function
        function updateDashboard(level, pumpStatus, sirenStatus) {
            lastLevel = level; lastPump = pumpStatus; lastSiren = sirenStatus;
            updateDashboardText();
            
            gaugeChart.updateSeries([level]);
            historyData.push(level); if(historyData.length>20) historyData.shift();
            lineChart.updateSeries([{ data: historyData }]);
            
            if (level > 80) gaugeChart.updateOptions({ colors: ['#ef4444'] });
            else gaugeChart.updateOptions({ colors: ['#4f46e5'] });

            const pumpCard = document.getElementById('btnPump');
            if (pumpStatus) pumpCard.classList.add('active'); 
            else pumpCard.classList.remove('active');
        }

        function updateDashboardText() {
            const t = translations[currentLang];
            document.getElementById('waterLevelText').innerText = lastLevel + "%";
            document.getElementById('mqttText').innerText = client && client.isConnected() ? t["iot.connected"] : t["iot.disconnected"];
            
            const alertBox = document.getElementById('statusAlert');
            const sirenTxt = document.getElementById('sirenText');
            
            if (lastLevel > 80) {
                alertBox.className = "alert-box danger"; alertBox.innerHTML = "<i class='bx bx-error-circle'></i> " + t["status.danger"];
                if(lastSiren) { sirenTxt.innerText = t["siren.on"]; sirenTxt.style.color = "#ef4444"; }
            } else {
                alertBox.className = "alert-box"; alertBox.innerHTML = "<i class='bx bx-check-circle'></i> " + t["status.safe"];
                sirenTxt.innerText = t["siren.off"]; sirenTxt.style.color = "#64748b";
            }

            document.getElementById('pumpText').innerText = lastPump ? t["pump.on"] : t["pump.off"];
        }

        function togglePump() {
            const isCurrentlyOn = document.getElementById('btnPump').classList.contains('active');
            sendCommand("pump", !isCurrentlyOn);
            addLog("User", !isCurrentlyOn ? "Pump ON" : "Pump OFF", "ok");
        }

        // ... Other functions ...
        function switchTab(id, el) { document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); document.getElementById('tab-'+id).classList.add('active'); if(el){document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active')); el.classList.add('active');} }
        function addLog(s,d,t){ const tb=document.getElementById('logBody'); const r=`<tr><td>${new Date().toLocaleTimeString()}</td><td>${s}</td><td>${d}</td><td><span class="tag ${t}">${t}</span></td></tr>`; tb.insertAdjacentHTML('afterbegin',r); }
        let tempAvatar=currentAvatar; function selectAvatar(u,e){tempAvatar=u;document.querySelectorAll('.avatar-item').forEach(i=>i.classList.remove('selected'));e.classList.add('selected');document.getElementById('previewAvatar').src=u;}
        function saveProfile(){const n=document.getElementById('nameInput').value; if(n.trim()){currentUser=n;currentAvatar=tempAvatar;localStorage.setItem('currentUser',n);localStorage.setItem('currentAvatar',tempAvatar);updateProfileUI(n,tempAvatar);alert("Saved!");}}
        function logout(){if(confirm("Logout?")){localStorage.removeItem('currentUser');window.location.href='index.html';}}
        
        // Background & Theme Settings
        function changeBg(e) {
            const file = e.target.files[0];
            if(file){
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const bgData = evt.target.result;
                    document.body.style.backgroundImage = `url('${bgData}')`;
                    try{
                        localStorage.setItem('modern_bg', bgData);
                        alert("ƒê√£ c·∫≠p nh·∫≠t h√¨nh n·ªÅn!");
                        const uploadZone = document.querySelector('.upload-zone');
                        uploadZone.innerHTML = `<i class='bx bx-check-circle' style="font-size: 40px; color: var(--success);"></i><div style="margin-top: 10px; font-weight: 600; color: var(--success);">ƒê√£ t·∫£i ·∫£nh l√™n!</div>`;
                        uploadZone.style.borderColor = 'var(--success)';
                        uploadZone.style.background = '#ecfdf5';
                    } catch(e){
                        alert("B·ªô nh·ªõ ƒë·∫ßy, ·∫£nh ch·ªâ hi·ªán t·∫°m th·ªùi.");
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        function resetBg() {
            localStorage.removeItem('modern_bg');
            document.body.style.backgroundImage = "url('https://images.unsplash.com/photo-1493246507139-91e8fad9978e?q=80&w=2670&auto=format&fit=crop')";
            const uploadZone = document.querySelector('.upload-zone');
            uploadZone.innerHTML = `<i class='bx bx-cloud-upload' style="font-size: 40px; color: var(--primary);"></i><div style="margin-top: 10px; font-weight: 600;">Nh·∫•n ƒë·ªÉ t·∫£i ·∫£nh l√™n</div>`;
            uploadZone.style.borderColor = '#cbd5e1';
            uploadZone.style.background = 'var(--bg-card)';
            alert("ƒê√£ kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh!");
        }
        function toggleDarkMode(){const d=document.getElementById('darkModeToggle').checked; if(d)document.body.classList.add('dark-mode');else document.body.classList.remove('dark-mode'); localStorage.setItem('darkMode',d); lineChart.updateOptions({theme:{mode:d?'dark':'light'}});}
        function saveSetting(k,v){localStorage.setItem(k,v);}

        // --- 5. MQTT SETUP (CH·∫†Y SAU C√ôNG) ---
        const mqttHost = "broker.hivemq.com"; const mqttPort = 8884; 
        const mqttTopic = "shadowfox/system_data"; const mqttTopicCmd = "shadowfox/commands";

        function connectMQTT() {
            const clientId = "client-" + Math.random().toString(16).substr(2, 8);
            client = new Paho.MQTT.Client(mqttHost, mqttPort, clientId);
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;
            client.connect({ onSuccess: onConnect, onFailure: onFailure, useSSL: true });
        }
        function onConnect() {
            document.getElementById('mqttStatus').className = 'iot-status connected';
            document.getElementById('mqttText').innerText = translations[currentLang]["iot.connected"];
            client.subscribe(mqttTopic);
        }
        function onFailure(e) { console.log(e); setTimeout(connectMQTT, 5000); }
        function onConnectionLost(e) { if(e.errorCode!==0) setTimeout(connectMQTT, 5000); }
        function onMessageArrived(msg) {
            try { const data = JSON.parse(msg.payloadString); updateDashboard(data.waterLevel, data.isPumpOn, data.isSirenOn); } catch(e){}
        }
        function sendCommand(cmd, val) {
            if(client && client.isConnected()) {
                const msg = new Paho.MQTT.Message(JSON.stringify({ device: cmd, state: val }));
                msg.destinationName = mqttTopicCmd; client.send(msg);
            }
        }
        
        // START
        changeLanguage(currentLang); // D·ªãch l·∫ßn ƒë·∫ßu
        setInterval(updateTime, 1000); updateTime(); // Ch·∫°y ƒë·ªìng h·ªì
        connectMQTT(); // K·∫øt n·ªëi IoT
        addLog("System", "Init", "ok");
    </script>
</body>
</html>