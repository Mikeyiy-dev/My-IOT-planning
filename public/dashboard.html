<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShadowFox - Modern Dashboard</title>
    
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #e0e7ff;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-light: #9ca3af;
            --sidebar-w: 260px;
            --radius: 20px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* DARK MODE */
        body.dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-light: #94a3b8;
            --primary-light: #312e81;
            --secondary: #94a3b8;
        }
        body.dark-mode .sidebar, body.dark-mode .content-container {
            background: rgba(30, 41, 59, 0.95);
            border-color: rgba(255,255,255,0.1);
        }
        body.dark-mode .menu-item:hover { background: #334155; }
        body.dark-mode .card, body.dark-mode .input-modern, body.dark-mode .modern-table th, body.dark-mode .modern-table td {
            border-color: #334155;
        }
        body.dark-mode .upload-zone { background: #1e293b; border-color: #475569; }
        body.dark-mode .pump-card:hover { background: #334155; }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        
        body { 
            background-color: var(--bg-body); 
            background-image: url('https://images.unsplash.com/photo-1493246507139-91e8fad9978e?q=80&w=2670&auto=format&fit=crop');
            background-size: cover; background-position: center; background-attachment: fixed;
            display: flex; min-height: 100vh; color: var(--text-main);
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-w);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            height: 96vh; margin: 2vh; 
            border-radius: var(--radius);
            display: flex; flex-direction: column;
            box-shadow: var(--shadow);
            z-index: 100; border: 1px solid rgba(255,255,255,0.5);
        }
        
        .logo-box {
            padding: 25px 20px; display: flex; align-items: center; gap: 12px;
            border-bottom: 1px solid var(--primary-light);
        }
        .logo-img { width: 45px; height: auto; max-height: 45px; object-fit: contain; }
        .logo-text h3 { font-size: 18px; font-weight: 700; color: var(--text-main); margin: 0; }
        .logo-text span { font-size: 12px; color: var(--text-light); }

        .menu { list-style: none; padding: 20px; flex: 1; }
        .menu-item {
            padding: 14px 16px; margin-bottom: 8px; border-radius: 12px;
            display: flex; align-items: center; gap: 14px; color: var(--secondary);
            cursor: pointer; transition: 0.2s; font-weight: 500; font-size: 15px;
        }
        .menu-item:hover { background: #f8fafc; color: var(--primary); }
        .menu-item.active { 
            background: var(--primary); color: white; font-weight: 600;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        .menu-item i { font-size: 22px; }

        .user-footer {
            padding: 20px; border-top: 1px solid #f1f5f9;
            display: flex; align-items: center; gap: 12px; cursor: pointer;
            transition: 0.2s;
        }
        .user-footer:hover { background: var(--primary-light); border-radius: 0 0 var(--radius) var(--radius); }
        .user-avatar { 
            width: 40px; height: 40px; border-radius: 10px; object-fit: contain;
            background: #f1f5f9; padding: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- MAIN CONTENT --- */
        .main { flex: 1; padding: 2vh 2vh 2vh 0; overflow-y: auto; height: 100vh; }
        
        .content-container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            border-radius: var(--radius);
            min-height: 96vh; padding: 30px;
            box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.5);
            display: flex; flex-direction: column;
        }

        /* HEADER */
        .top-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; padding-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .greeting h2 { margin: 0; font-size: 24px; color: var(--text-main); }
        .date-display { color: var(--text-light); font-size: 14px; margin-top: 5px; font-weight: 500; }
        .clock-display {
            font-size: 32px; font-weight: 700; color: var(--primary);
            font-variant-numeric: tabular-nums;
            background: rgba(255,255,255,0.5); padding: 5px 20px; border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* IOT STATUS */
        .iot-status {
            font-size: 12px; padding: 5px 10px; border-radius: 20px; background: #eee; color: #666;
            display: inline-flex; align-items: center; gap: 5px; margin-top: 5px;
        }
        .iot-status.connected { background: #d1fae5; color: #065f46; }
        .iot-dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
        .iot-status.connected .iot-dot { background: #10b981; box-shadow: 0 0 5px #10b981; }

        /* TABS */
        .tab-content { display: none; animation: fadeIn 0.4s ease; flex: 1; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* GRID LAYOUTS */
        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }

        /* CARDS */
        .card {
            background: var(--bg-card); border-radius: 16px; padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #e2e8f0;
            margin-bottom: 25px; position: relative; overflow: hidden;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .card-title i { color: var(--primary); font-size: 20px; }

        /* WIDGETS */
        .camera-container {
            width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px;
            overflow: hidden; position: relative;
        }
        .camera-container img { width: 100%; height: 100%; object-fit: cover; }
        .live-badge {
            position: absolute; top: 12px; left: 12px;
            background: rgba(239, 68, 68, 0.9); color: white; padding: 4px 10px;
            border-radius: 6px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px;
            display: flex; align-items: center; gap: 6px;
        }
        .live-badge::before { content:''; width: 6px; height: 6px; background: white; border-radius: 50%; }

        .pump-card {
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
            padding: 40px 20px; transition: 0.3s; cursor: pointer; border: 2px solid transparent;
        }
        .pump-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .pump-icon {
            width: 70px; height: 70px; background: var(--primary-light); color: var(--primary);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 32px; margin-bottom: 15px; transition: 0.3s;
        }
        .pump-card.active { border-color: var(--primary); background: #f0f7ff; }
        .pump-card.active .pump-icon { background: var(--primary); color: white; box-shadow: 0 0 15px rgba(79, 70, 229, 0.4); }

        .stat-value { font-size: 36px; font-weight: 700; color: var(--text-main); margin: 10px 0; }
        .alert-box {
            padding: 15px; border-radius: 12px; background: #ecfdf5; color: var(--success);
            font-weight: 600; font-size: 14px; text-align: center; border: 1px solid #d1fae5;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .alert-box.danger { background: #fef2f2; color: var(--danger); border-color: #fee2e2; }

        .avatar-grid { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px; }
        .avatar-item {
            width: 70px; height: 70px; border-radius: 50%; padding: 10px; border: 3px solid #e2e8f0;
            cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; background: #fff;
        }
        .avatar-item img { width: 100%; height: 100%; object-fit: contain; }
        .avatar-item:hover, .avatar-item.selected { border-color: var(--primary); transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        .input-modern { width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; margin-top: 10px; outline: none; transition: 0.2s; background: var(--bg-card); color: var(--text-main); }
        .input-modern:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

        .btn { padding: 12px 24px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; width: 100%; margin-top: 15px; }
        .btn-primary:hover { background: #4338ca; }
        .btn-danger { background: #fee2e2; color: var(--danger); width: 100%; margin-top: 10px; }
        .btn-danger:hover { background: #fecaca; }

        .upload-zone { 
            display: block; border: 2px dashed #cbd5e1; border-radius: 12px; padding: 40px; text-align: center; 
            cursor: pointer; color: var(--secondary); transition: 0.3s; background: var(--bg-card); 
        }
        .upload-zone:hover { border-color: var(--primary); background: var(--primary-light); }

        .modern-table { width: 100%; border-collapse: collapse; }
        .modern-table th { text-align: left; padding: 16px; color: var(--text-light); font-weight: 600; border-bottom: 1px solid #e2e8f0; font-size: 13px; text-transform: uppercase; }
        .modern-table td { padding: 16px; border-bottom: 1px solid #f1f5f9; color: var(--text-main); font-size: 14px; }
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .tag.ok { background: #ecfdf5; color: var(--success); }
        .tag.warn { background: #fffbeb; color: var(--warning); }
        .tag.err { background: #fef2f2; color: var(--danger); }

        .setting-section { margin-bottom: 30px; }
        .setting-title { font-size: 13px; font-weight: 700; color: var(--text-light); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f5f9; }
        .setting-info h4 { font-size: 15px; font-weight: 600; margin: 0 0 5px 0; color: var(--text-main); }
        .setting-info p { font-size: 13px; color: var(--text-light); margin: 0; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }
        .form-select { padding: 10px 15px; border-radius: 10px; border: 1px solid #e2e8f0; outline: none; color: var(--text-main); font-family: 'Inter'; font-size: 14px; background-color: var(--bg-card); cursor: pointer; }

        @media (max-width: 1024px) {
            .sidebar { width: 80px; } .logo-text, .menu-item span, .user-footer div { display: none; }
            .menu-item { justify-content: center; padding: 14px; } .logo-box { justify-content: center; padding: 30px 0; }
            .dashboard-grid { grid-template-columns: 1fr; } .top-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .clock-display { font-size: 24px; align-self: flex-end; }
        }
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: auto; height: auto; margin: 0; border-radius: 0; flex-direction: row; justify-content: space-between; padding: 10px; }
            .menu { display: flex; padding: 0; } .main { padding: 0; height: auto; } .content-container { border-radius: 0; border: none; padding: 20px; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo-box">
            <img src="logo.png" alt="Logo" class="logo-img">
            <div class="logo-text">
                <h3>ShadowFox</h3>
                <span>IoT System</span>
            </div>
        </div>

        <ul class="menu">
            <li class="menu-item active" onclick="switchTab('home', this)">
                <i class='bx bx-grid-alt'></i> <span data-i18n="menu.home">T·ªïng quan</span>
            </li>
            <li class="menu-item" onclick="switchTab('camera', this)">
                <i class='bx bx-cctv'></i> <span data-i18n="menu.camera">Camera</span>
            </li>
            <li class="menu-item" onclick="switchTab('logs', this)">
                <i class='bx bx-list-ul'></i> <span data-i18n="menu.logs">Nh·∫≠t k√Ω</span>
            </li>
            
            <li class="menu-item" id="menuAdmin" onclick="switchTab('admin', this)" style="display: none;">
                <i class='bx bx-crown'></i> <span>Qu·∫£n tr·ªã vi√™n</span>
            </li>

            <li class="menu-item" onclick="switchTab('account', this)">
                <i class='bx bx-user'></i> <span data-i18n="menu.account">T√†i kho·∫£n</span>
            </li>
            <li class="menu-item" onclick="switchTab('settings', this)">
                <i class='bx bx-cog'></i> <span data-i18n="menu.settings">C√†i ƒë·∫∑t</span>
            </li>
        </ul>

        <div class="user-footer" onclick="switchTab('account', null)">
            <img src="https://cdn-icons-png.flaticon.com/512/616/616408.png" class="user-avatar" id="sidebarAvatar">
            <div>
                <div style="font-weight: 600; font-size: 14px;" id="sidebarName">Guest</div>
                <div style="font-size: 12px; color: #9ca3af;" id="sidebarRole">Viewer</div>
            </div>
        </div>
    </aside>

    <main class="main">
        <div class="content-container">
            
            <div class="top-header">
                <div class="greeting">
                    <h2><span data-i18n="header.hello">Xin ch√†o</span>, <span id="headerName" style="color: var(--primary);">Guest</span>! üëã</h2>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <p class="date-display" id="dateDisplay">...</p>
                        <div class="iot-status" id="mqttStatus"><div class="iot-dot"></div> <span id="mqttText" data-i18n="iot.disconnected">Ng·∫Øt k·∫øt n·ªëi</span></div>
                    </div>
                </div>
                <div class="clock-display" id="clockDisplay">00:00:00</div>
            </div>

            <div id="tab-home" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="left-col">
                        <div class="card" style="padding: 0; border: none; overflow: hidden;">
                            <div class="camera-container">
                                <div class="live-badge">‚óè LIVE</div>
                                <img id="camStream1" src="https://images.unsplash.com/photo-1518386377785-132b4b443213?q=80&w=2670&auto=format&fit=crop">
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header"><span class="card-title"><i class='bx bx-line-chart'></i> <span data-i18n="chart.title">Bi·ªÉu ƒë·ªì m·ª±c n∆∞·ªõc</span></span></div>
                            <div id="lineChart" style="min-height: 250px;"></div>
                        </div>
                    </div>
                    <div class="right-col">
                        <div class="card" style="text-align: center;">
                            <div class="card-title" style="justify-content: center; margin-bottom: 5px;" data-i18n="gauge.title">M·ª±c n∆∞·ªõc hi·ªán t·∫°i</div>
                            <div id="gaugeChart" style="margin-top: -15px;"></div>
                            <div class="stat-value" id="waterLevelText" style="color: var(--primary);">0%</div>
                            <div id="statusAlert" class="alert-box"><i class='bx bx-loader-alt bx-spin'></i> <span data-i18n="status.waiting">ƒêang ƒë·ª£i d·ªØ li·ªáu...</span></div>
                        </div>
                        <div class="card">
                            <div class="card-title" data-i18n="controls.title">ƒêi·ªÅu khi·ªÉn</div>
                            <div id="btnPump" class="pump-card" onclick="togglePump()">
                                <div class="pump-icon"><i class='bx bx-water'></i></div>
                                <div><div style="font-weight: 600;" data-i18n="pump.name">M√°y B∆°m</div><div style="font-size: 12px; color: var(--text-light);" id="pumpText">OFF</div></div>
                            </div>
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #f1f5f9;">
                                <div style="display: flex; justify-content: space-between; font-size: 13px; color: var(--secondary);">
                                    <span data-i18n="siren.label">Tr·∫°ng th√°i C√≤i h√∫:</span><span style="font-weight: 600;" id="sirenText">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-camera" class="tab-content">
                <div class="card" style="height: 75vh; padding: 0; overflow: hidden; background: #000;">
                    <div class="camera-container" style="height: 100%; border-radius: 0;">
                        <img id="camStream2" src="https://images.unsplash.com/photo-1518386377785-132b4b443213?q=80&w=2670&auto=format&fit=crop">
                    </div>
                </div>
            </div>

            <div id="tab-logs" class="tab-content">
                <div class="card">
                    <div class="card-header"><span class="card-title"><i class='bx bx-history'></i> <span data-i18n="logs.title">Nh·∫≠t k√Ω ho·∫°t ƒë·ªông</span></span>
                    <button class="btn" style="border: 1px solid #e2e8f0; padding: 8px 16px;">Export CSV</button></div>
                    <table class="modern-table">
                        <thead><tr>
                            <th data-i18n="table.time">Th·ªùi gian</th>
                            <th data-i18n="table.event">S·ª± ki·ªán</th>
                            <th data-i18n="table.detail">Chi ti·∫øt</th>
                            <th data-i18n="table.status">Tr·∫°ng th√°i</th>
                        </tr></thead><tbody id="logBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-admin" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class='bx bx-user-voice'></i> Qu·∫£n l√Ω ng∆∞·ªùi d√πng</span>
                        <button class="btn btn-primary" onclick="loadUserList()" style="width: auto;">L√†m m·ªõi</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>T√™n t√†i kho·∫£n</th>
                                    <th>Email</th>
                                    <th>Vai tr√≤</th>
                                    <th>H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="userListBody">
                                <tr><td colspan="4" style="text-align:center;">ƒêang t·∫£i...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-account" class="tab-content">
                <div class="card" style="max-width: 500px; margin: 0 auto;">
                    <div class="card-header"><span class="card-title"><i class='bx bx-id-card'></i> <span data-i18n="account.title">Th√¥ng tin t√†i kho·∫£n</span></span></div>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img id="previewAvatar" src="https://cdn-icons-png.flaticon.com/512/616/616408.png" style="width: 100px; height: 100px; border-radius: 50%; object-fit: contain; border: 4px solid var(--primary-light); background: #f8fafc; padding: 10px;">
                        <h2 style="margin-top: 10px;" id="previewName">User</h2>
                        <span class="tag ok" id="previewRole">Viewer</span>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="font-size: 13px; font-weight: 600; color: var(--secondary);" data-i18n="account.choose_avatar">Ch·ªçn nh√¢n v·∫≠t ƒë·∫°i di·ªán:</label>
                        <div class="avatar-grid">
                            <div class="avatar-item selected" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/616/616408.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/616/616408.png"></div>
                            <div class="avatar-item" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/616/616432.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/616/616432.png"></div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveProfile()" data-i18n="btn.save">L∆∞u thay ƒë·ªïi</button>
                    <button class="btn btn-danger" onclick="logout()" data-i18n="btn.logout">ƒêƒÉng xu·∫•t</button>
                </div>
            </div>

            <div id="tab-settings" class="tab-content">
                <div class="card" style="max-width: 650px; margin: 0 auto;">
                    <div class="card-header"><span class="card-title"><i class='bx bx-cog'></i> <span data-i18n="settings.title">C√†i ƒë·∫∑t h·ªá th·ªëng</span></span></div>
                    <div class="setting-section">
                        <div class="setting-title" data-i18n="settings.interface">Giao di·ªán</div>
                        <div class="setting-row">
                            <div class="setting-info"><h4 data-i18n="settings.dark_mode">Ch·∫ø ƒë·ªô T·ªëi</h4><p data-i18n="settings.dark_mode_desc">Giao di·ªán t·ªëi b·∫£o v·ªá m·∫Øt.</p></div>
                            <label class="switch"><input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()"><span class="slider"></span></label>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- 1. C·∫§U H√åNH ---
        const mqttHost = "broker.hivemq.com"; 
        const mqttPort = 8884;
        const mqttTopic = "shadowfox/system_data";
        
        let client = null;
        let lastLevel = 0; let lastPump = false; let lastSiren = false;
        
        // --- 2. L·∫§Y TH√îNG TIN ƒêƒÇNG NH·∫¨P ---
        const currentUser = localStorage.getItem('currentUser') || "Guest"; 
        let userRole = localStorage.getItem('userRole') || 'viewer';

        // SUPER ADMIN CHECK
        if (currentUser === 'Mikeyiy') userRole = 'admin';

        // --- 3. KH·ªûI T·∫†O ---
        function init() {
            // C·∫≠p nh·∫≠t UI T√™n & Avatar
            document.getElementById('sidebarName').innerText = currentUser;
            document.getElementById('headerName').innerText = currentUser;
            document.getElementById('sidebarRole').innerText = userRole.toUpperCase();
            document.getElementById('previewName').innerText = currentUser;
            document.getElementById('previewRole').innerText = userRole.toUpperCase();
            
            let currentAvatar = localStorage.getItem('currentAvatar') || "https://cdn-icons-png.flaticon.com/512/616/616408.png";
            document.getElementById('sidebarAvatar').src = currentAvatar;
            document.getElementById('previewAvatar').src = currentAvatar;

            // PH√ÇN QUY·ªÄN
            const pumpBtn = document.getElementById('btnPump');
            const adminMenu = document.getElementById('menuAdmin');

            if (userRole === 'admin') {
                pumpBtn.style.opacity = '1';
                pumpBtn.style.cursor = 'pointer';
                if(adminMenu) adminMenu.style.display = 'flex';
            } else {
                pumpBtn.style.opacity = '0.5';
                pumpBtn.style.cursor = 'not-allowed';
                pumpBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); alert("‚õî CH·ªà XEM: B·∫°n kh√¥ng c√≥ quy·ªÅn ƒëi·ªÅu khi·ªÉn!"); };
                document.getElementById('pumpText').innerText = "CH·ªà XEM (VIEW ONLY)";
                if(adminMenu) adminMenu.style.display = 'none';
            }

            // Dark Mode
            if(localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').checked = true;
            }

            connectMQTT();
            updateTime();
            setInterval(updateTime, 1000);
        }

        // --- 4. C√ÅC H√ÄM CH·ª®C NƒÇNG ---
        async function togglePump() {
            if (userRole !== 'admin') return;
            const isCurrentlyOn = document.getElementById('btnPump').classList.contains('active');
            const action = isCurrentlyOn ? 'OFF' : 'ON';
            document.getElementById('pumpText').innerText = "ƒêang g·ª≠i...";
            
            try {
                const r = await fetch('/api/control-pump', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: currentUser, action })
                });
                const d = await r.json();
                if (!d.success) alert("L·ªói: " + d.message);
            } catch(e) { alert("L·ªói k·∫øt n·ªëi Server!"); }
        }

        async function loadUserList() {
            if (userRole !== 'admin') return;
            const tbody = document.getElementById('userListBody');
            tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
            try {
                const res = await fetch('/api/list-users', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ requestBy: currentUser })
                });
                const data = await res.json();
                tbody.innerHTML = '';
                if (data.success) {
                    data.users.forEach(u => {
                        let btn = `<button class="btn btn-primary" style="padding:5px; margin:0; font-size:12px;" onclick="changeRole('${u.username}', 'admin')">L√™n Admin</button>`;
                        if (u.role === 'admin') btn = `<button class="btn btn-danger" style="padding:5px; margin:0; font-size:12px;" onclick="changeRole('${u.username}', 'viewer')">Xu·ªëng Viewer</button>`;
                        if (u.username === 'Mikeyiy') btn = '<span class="tag ok">SUPER ADMIN</span>';
                        tbody.insertAdjacentHTML('beforeend', `<tr><td><b>${u.username}</b></td><td>${u.email}</td><td><span class="tag ${u.role==='admin'?'ok':'warn'}">${u.role}</span></td><td>${btn}</td></tr>`);
                    });
                }
            } catch(e) {}
        }

        async function changeRole(target, newRole) {
            if(!confirm(`ƒê·ªïi quy·ªÅn ${target} th√†nh ${newRole}?`)) return;
            await fetch('/api/set-user-role', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ requestBy: currentUser, targetUser: target, newRole })
            });
            loadUserList();
        }

        function switchTab(id, el) { 
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); 
            document.getElementById('tab-'+id).classList.add('active'); 
            if(el) { document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active')); el.classList.add('active'); }
        }

        function logout() {
            if(confirm("ƒêƒÉng xu·∫•t?")) { localStorage.removeItem('currentUser'); localStorage.removeItem('userRole'); window.location.href='index.html'; }
        }
        function saveProfile() { localStorage.reload(); }
        function selectAvatar(u, e) { localStorage.setItem('currentAvatar', u); document.querySelectorAll('.avatar-item').forEach(i=>i.classList.remove('selected')); e.classList.add('selected'); document.getElementById('previewAvatar').src=u; }
        function toggleDarkMode() { const d = document.getElementById('darkModeToggle').checked; if(d) document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode'); localStorage.setItem('darkMode', d); }

        function updateTime() { const now = new Date(); document.getElementById('clockDisplay').innerText = now.toLocaleTimeString('vi-VN',{hour12:false}); }

        // MQTT
        function connectMQTT() {
            const clientId = "web-" + Math.random().toString(16).substr(2, 8);
            client = new Paho.MQTT.Client(mqttHost, mqttPort, clientId);
            client.onMessageArrived = (msg) => {
                try { 
                    const data = JSON.parse(msg.payloadString);
                    document.getElementById('waterLevelText').innerText = data.waterLevel + "%";
                    gaugeChart.updateSeries([data.waterLevel]);
                    const btn = document.getElementById('btnPump');
                    if(data.isPumpOn) { btn.classList.add('active'); if(userRole==='admin') document.getElementById('pumpText').innerText="ƒêANG CH·∫†Y"; }
                    else { btn.classList.remove('active'); if(userRole==='admin') document.getElementById('pumpText').innerText="ƒêANG T·∫ÆT"; }
                } catch(e){}
            };
            client.connect({ onSuccess: () => { client.subscribe(mqttTopic); document.getElementById('mqttStatus').className = 'iot-status connected'; document.getElementById('mqttText').innerText="ƒê√£ k·∫øt n·ªëi"; }, useSSL: true });
        }

        // CHARTS
        var lineChart = new ApexCharts(document.querySelector("#lineChart"), { series: [{name:'N∆∞·ªõc',data:[0]}], chart: {type:'area',height:250,toolbar:{show:false}}, stroke:{curve:'smooth'} }); lineChart.render();
        var gaugeChart = new ApexCharts(document.querySelector("#gaugeChart"), { series: [0], chart: {type:'radialBar',height:250}, plotOptions:{radialBar:{hollow:{size:'60%'}}} }); gaugeChart.render();

        // CH·∫†Y
        init();
    </script>
</body>
</html>