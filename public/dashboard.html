<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShadowFox - Modern Dashboard</title>
    
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        :root { --primary: #4f46e5; --primary-light: #e0e7ff; --secondary: #64748b; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --bg-body: #f3f4f6; --bg-card: #ffffff; --text-main: #1f2937; --text-light: #9ca3af; --sidebar-w: 260px; --radius: 20px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        body.dark-mode { --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; --text-light: #94a3b8; --primary-light: #312e81; --secondary: #94a3b8; }
        body.dark-mode .sidebar, body.dark-mode .content-container { background: rgba(30, 41, 59, 0.95); border-color: rgba(255,255,255,0.1); }
        body.dark-mode .menu-item:hover { background: #334155; }
        body.dark-mode .card, body.dark-mode .input-modern, body.dark-mode .modern-table th, body.dark-mode .modern-table td, body.dark-mode .form-select, body.dark-mode .modal-content { border-color: #334155; background: #1e293b; color: #f1f5f9; }
        body.dark-mode .upload-zone { background: #1e293b; border-color: #475569; }
        body.dark-mode .pump-card:hover { background: #334155; }
        body.transparent-ui .sidebar, body.transparent-ui .content-container, body.transparent-ui .card, body.transparent-ui .modal-content { background: rgba(255, 255, 255, 0.25) !important; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); }
        body.dark-mode.transparent-ui .sidebar, body.dark-mode.transparent-ui .content-container, body.dark-mode.transparent-ui .card, body.dark-mode.transparent-ui .modal-content { background: rgba(0, 0, 0, 0.4) !important; border: 1px solid rgba(255, 255, 255, 0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        body { background-color: var(--bg-body); background-image: url('https://images.unsplash.com/photo-1493246507139-91e8fad9978e?q=80&w=2670&auto=format&fit=crop'); background-size: cover; background-position: center; background-attachment: fixed; display: flex; min-height: 100vh; color: var(--text-main); }
        .sidebar { width: var(--sidebar-w); background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); height: 96vh; margin: 2vh; border-radius: var(--radius); display: flex; flex-direction: column; box-shadow: var(--shadow); z-index: 100; border: 1px solid rgba(255,255,255,0.5); }
        .logo-box { padding: 25px 20px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--primary-light); }
        .logo-img { width: 45px; height: auto; max-height: 45px; object-fit: contain; }
        .logo-text h3 { font-size: 18px; font-weight: 700; color: var(--text-main); margin: 0; }
        .logo-text span { font-size: 12px; color: var(--text-light); }
        .menu { list-style: none; padding: 20px; flex: 1; }
        .menu-item { padding: 14px 16px; margin-bottom: 8px; border-radius: 12px; display: flex; align-items: center; gap: 14px; color: var(--secondary); cursor: pointer; transition: 0.2s; font-weight: 500; font-size: 15px; }
        .menu-item:hover { background: #f8fafc; color: var(--primary); }
        .menu-item.active { background: var(--primary); color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .menu-item i { font-size: 22px; }
        .user-footer { padding: 20px; border-top: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; }
        .user-footer:hover { background: var(--primary-light); border-radius: 0 0 var(--radius) var(--radius); }
        .user-avatar { width: 40px; height: 40px; border-radius: 10px; object-fit: contain; background: #f1f5f9; padding: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .main { flex: 1; padding: 2vh 2vh 2vh 0; overflow-y: auto; height: 100vh; }
        .content-container { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(15px); border-radius: var(--radius); min-height: 96vh; padding: 30px; box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.5); display: flex; flex-direction: column; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .greeting h2 { margin: 0; font-size: 24px; color: var(--text-main); }
        .date-display { color: var(--text-light); font-size: 14px; margin-top: 5px; font-weight: 500; }
        .clock-display { font-size: 32px; font-weight: 700; color: var(--primary); font-variant-numeric: tabular-nums; background: rgba(255,255,255,0.5); padding: 5px 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .iot-status { font-size: 12px; padding: 5px 10px; border-radius: 20px; background: #eee; color: #666; display: inline-flex; align-items: center; gap: 5px; margin-top: 5px; }
        .iot-status.connected { background: #d1fae5; color: #065f46; }
        .iot-dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
        .iot-status.connected .iot-dot { background: #10b981; box-shadow: 0 0 5px #10b981; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; flex: 1; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .card { background: var(--bg-card); border-radius: 16px; padding: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; margin-bottom: 25px; position: relative; overflow: hidden; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .card-title i { color: var(--primary); font-size: 20px; }
        
        .camera-container { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; }
        .camera-container img { width: 100%; height: 100%; object-fit: contain; }
        .live-badge { position: absolute; top: 12px; left: 12px; background: #64748b; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; z-index: 10; }
        .live-badge.alert { background: #ef4444; animation: flashRed 1s infinite; }
        .live-badge::before { content:''; width: 6px; height: 6px; background: white; border-radius: 50%; }

        .pump-card { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px 20px; transition: 0.3s; cursor: pointer; border: 2px solid transparent; }
        .pump-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .pump-icon { width: 70px; height: 70px; background: var(--primary-light); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; margin-bottom: 15px; transition: 0.3s; }
        .pump-card.active { border-color: var(--primary); background: #f0f7ff; }
        .pump-card.active .pump-icon { background: var(--primary); color: white; box-shadow: 0 0 15px rgba(79, 70, 229, 0.4); }
        .stat-value { font-size: 36px; font-weight: 700; color: var(--text-main); margin: 10px 0; }
        .alert-box { padding: 15px; border-radius: 12px; background: #ecfdf5; color: var(--success); font-weight: 600; font-size: 14px; text-align: center; border: 1px solid #d1fae5; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .alert-box.danger { background: #fef2f2; color: var(--danger); border-color: #fee2e2; }
        .avatar-grid { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px; }
        .avatar-item { width: 70px; height: 70px; border-radius: 50%; padding: 10px; border: 3px solid #e2e8f0; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; background: #fff; }
        .avatar-item img { width: 100%; height: 100%; object-fit: contain; }
        .avatar-item:hover, .avatar-item.selected { border-color: var(--primary); transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .input-modern { width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 10px; margin-top: 10px; outline: none; transition: 0.2s; background: var(--bg-card); color: var(--text-main); }
        .input-modern:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .btn { padding: 12px 24px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; width: 100%; margin-top: 15px; }
        .btn-primary:hover { background: #4338ca; }
        .btn-danger { background: #fee2e2; color: var(--danger); width: 100%; margin-top: 10px; }
        .btn-danger:hover { background: #fecaca; }
        .modern-table { width: 100%; border-collapse: collapse; }
        .modern-table th { text-align: left; padding: 16px; color: var(--text-light); font-weight: 600; border-bottom: 1px solid #e2e8f0; font-size: 13px; text-transform: uppercase; }
        .modern-table td { padding: 16px; border-bottom: 1px solid #f1f5f9; color: var(--text-main); font-size: 14px; }
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .tag.ok { background: #ecfdf5; color: var(--success); }
        .tag.warn { background: #fffbeb; color: var(--warning); }
        .setting-section { margin-bottom: 30px; }
        .setting-title { font-size: 13px; font-weight: 700; color: var(--text-light); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f5f9; }
        .setting-info h4 { font-size: 15px; font-weight: 600; margin: 0 0 5px 0; color: var(--text-main); }
        .setting-info p { font-size: 13px; color: var(--text-light); margin: 0; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }
        .form-select { padding: 10px 15px; border-radius: 10px; border: 1px solid #e2e8f0; outline: none; color: var(--text-main); font-family: 'Inter'; font-size: 14px; background-color: var(--bg-card); cursor: pointer; }
        
        @keyframes flashRed { 0% { background: #ef4444; } 50% { background: #b91c1c; } 100% { background: #ef4444; } }
        /* MODAL STYLES */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--bg-card); margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 400px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: fadeIn 0.3s; position: relative; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; top: 10px; right: 15px; }
        .close:hover, .close:focus { color: var(--danger); text-decoration: none; cursor: pointer; }
        .fab-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4); cursor: pointer; transition: 0.3s; z-index: 90; border: none; }
        .fab-btn:hover { transform: scale(1.1) rotate(90deg); }

        @media (max-width: 1024px) {
            .sidebar { width: 80px; } .logo-text, .menu-item span, .user-footer div { display: none; }
            .menu-item { justify-content: center; padding: 14px; } .logo-box { justify-content: center; padding: 30px 0; }
            .dashboard-grid { grid-template-columns: 1fr; } .top-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .clock-display { font-size: 24px; align-self: flex-end; }
        }
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: auto; height: auto; margin: 0; border-radius: 0; flex-direction: row; justify-content: space-between; padding: 10px; }
            .menu { display: flex; padding: 0; } .main { padding: 0; height: auto; } .content-container { border-radius: 0; border: none; padding: 20px; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo-box">
            <img src="logo.png" alt="Logo" class="logo-img">
            <div class="logo-text">
                <h3>ShadowFox</h3>
                <span>IoT System</span>
            </div>
        </div>

        <ul class="menu">
            <li class="menu-item active" onclick="switchTab('home', this)">
                <i class='bx bx-grid-alt'></i> <span data-i18n="menu.home">T·ªïng quan</span>
            </li>
            <li class="menu-item" onclick="switchTab('camera', this)">
                <i class='bx bx-cctv'></i> <span data-i18n="menu.camera">Camera</span>
            </li>
            <li class="menu-item" onclick="switchTab('logs', this)">
                <i class='bx bx-list-ul'></i> <span data-i18n="menu.logs">Nh·∫≠t k√Ω</span>
            </li>
            <li class="menu-item" id="menuAdmin" onclick="switchTab('admin', this)" style="display: none;">
                <i class='bx bx-crown'></i> <span>Qu·∫£n tr·ªã vi√™n</span>
            </li>
            <li class="menu-item" onclick="switchTab('account', this)">
                <i class='bx bx-user'></i> <span data-i18n="menu.account">T√†i kho·∫£n</span>
            </li>
            <li class="menu-item" onclick="switchTab('settings', this)">
                <i class='bx bx-cog'></i> <span data-i18n="menu.settings">C√†i ƒë·∫∑t</span>
            </li>
        </ul>

        <div class="user-footer" onclick="switchTab('account', null)">
            <img src="https://cdn-icons-png.flaticon.com/512/616/616408.png" class="user-avatar" id="sidebarAvatar">
            <div>
                <div style="font-weight: 600; font-size: 14px;" id="sidebarName">Guest</div>
                <div style="font-size: 12px; color: #9ca3af;" id="sidebarRole">Viewer</div>
            </div>
        </div>
    </aside>

    <main class="main">
        <div class="content-container">
            <div class="top-header">
                <div class="greeting">
                    <h2><span data-i18n="header.hello">Xin ch√†o</span>, <span id="headerName" style="color: var(--primary);">Guest</span>! üëã</h2>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <p class="date-display" id="dateDisplay">...</p>
                        <div class="iot-status" id="mqttStatus"><div class="iot-dot"></div> <span id="mqttText" data-i18n="iot.disconnected">Ng·∫Øt k·∫øt n·ªëi</span></div>
                    </div>
                </div>
                <div class="clock-display" id="clockDisplay">00:00:00</div>
            </div>

            <div id="tab-home" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="left-col">
                        <div class="card" style="padding: 0; border: none; overflow: hidden;">
                            <div class="camera-container">
                                <div class="live-badge" id="camStatusBadge">‚óè WAIT SNAPSHOT</div>
                                
                                <button class="btn" onclick="triggerSnapshot()" style="position:absolute; top:12px; right:12px; padding:6px 12px; font-size:12px; background:rgba(255,255,255,0.9); color:#333; z-index:20; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
                                    <i class='bx bxs-camera'></i> Ch·ª•p Ngay
                                </button>
                                
                                <img id="eventImage" src="https://via.placeholder.com/800x450?text=Ch∆∞a+c√≥+·∫£nh+s·ª±+c·ªë+n√†o" alt="·∫¢nh s·ª± ki·ªán">
                                <div id="eventTime" style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">--:--:--</div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><span class="card-title"><i class='bx bx-line-chart'></i> <span data-i18n="chart.title">Bi·ªÉu ƒë·ªì m·ª±c n∆∞·ªõc</span></span></div>
                            <div id="lineChart" style="min-height: 250px;"></div>
                        </div>
                    </div>
                    <div class="right-col">
                        <div class="card" style="text-align: center;">
                            <div class="card-title" style="justify-content: center; margin-bottom: 5px;" data-i18n="gauge.title">M·ª±c n∆∞·ªõc hi·ªán t·∫°i</div>
                            <div id="gaugeChart" style="margin-top: -15px;"></div>
                            <div class="stat-value" id="waterLevelText" style="color: var(--primary); font-size: 32px;">0 cm</div>
                            <div id="statusAlert" class="alert-box"><i class='bx bx-loader-alt bx-spin'></i> <span data-i18n="status.waiting">ƒêang ƒë·ª£i d·ªØ li·ªáu...</span></div>
                        </div>
                        <div class="card">
                            <div class="card-title" data-i18n="controls.title">ƒêi·ªÅu khi·ªÉn</div>
                            <div id="btnPump" class="pump-card" onclick="togglePump()">
                                <div class="pump-icon"><i class='bx bx-water'></i></div>
                                <div><div style="font-weight: 600;" data-i18n="pump.name">M√°y B∆°m</div><div style="font-size: 12px; color: var(--text-light);" id="pumpText">OFF</div></div>
                            </div>
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #f1f5f9;">
                                <div style="display: flex; justify-content: space-between; font-size: 13px; color: var(--secondary);">
                                    <span data-i18n="siren.label">Tr·∫°ng th√°i C√≤i h√∫:</span><span style="font-weight: 600;" id="sirenText">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 style="margin: 30px 0 15px 0; font-size: 18px; color: var(--text-main); display: flex; align-items: center; gap: 10px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 20px;">
                    <i class='bx bx-extension'></i> Thi·∫øt b·ªã m·ªü r·ªông
                </h3>
                <div id="dynamic-grid" class="dashboard-grid" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                </div>
            </div>

            <div id="tab-camera" class="tab-content">
                <div class="card" style="height: 75vh; padding: 0; overflow: hidden; background: #000;">
                    <div class="camera-container" style="height: 100%; border-radius: 0;">
                        <img id="camStream2" src="https://nonintoxicating-excurvate-doria.ngrok-free.dev/stream">
                    </div>
                </div>
            </div>
            
            <div id="tab-logs" class="tab-content">
                <div class="card">
                    <div class="card-header"><span class="card-title"><i class='bx bx-history'></i> <span data-i18n="logs.title">Nh·∫≠t k√Ω ho·∫°t ƒë·ªông</span></span>
                    <button class="btn" style="border: 1px solid #e2e8f0; padding: 8px 16px;" onclick="exportData()">Export Excel/TXT</button></div>
                    <table class="modern-table"><thead><tr><th data-i18n="table.time">Th·ªùi gian</th><th data-i18n="table.event">S·ª± ki·ªán</th><th data-i18n="table.detail">Chi ti·∫øt</th><th data-i18n="table.status">Tr·∫°ng th√°i</th></tr></thead><tbody id="logBody"></tbody></table>
                </div>
            </div>

            <div id="tab-admin" class="tab-content">
                <div class="card">
                    <div class="card-header"><span class="card-title"><i class='bx bx-user-voice'></i> Qu·∫£n l√Ω ng∆∞·ªùi d√πng</span><button class="btn btn-primary" onclick="loadUserList()" style="width: auto;">L√†m m·ªõi</button></div>
                    <div style="overflow-x: auto;"><table class="modern-table"><thead><tr><th>T√™n t√†i kho·∫£n</th><th>Email</th><th>Vai tr√≤</th><th>H√†nh ƒë·ªông</th></tr></thead><tbody id="userListBody"><tr><td colspan="4" style="text-align:center;">ƒêang t·∫£i...</td></tr></tbody></table></div>
                </div>
            </div>

            <div id="tab-account" class="tab-content">
                <div class="card" style="max-width: 500px; margin: 0 auto;">
                    <div class="card-header"><span class="card-title"><i class='bx bx-id-card'></i> <span data-i18n="account.title">Th√¥ng tin t√†i kho·∫£n</span></span></div>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img id="previewAvatar" src="https://cdn-icons-png.flaticon.com/512/616/616408.png" style="width: 100px; height: 100px; border-radius: 50%; object-fit: contain; border: 4px solid var(--primary-light); background: #f8fafc; padding: 10px;">
                        <h2 style="margin-top: 10px;" id="previewName">User</h2>
                        <span class="tag ok" id="previewRole">Viewer</span>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="font-size: 13px; font-weight: 600; color: var(--secondary);" data-i18n="account.choose_avatar">Ch·ªçn nh√¢n v·∫≠t ƒë·∫°i di·ªán:</label>
                        <div class="avatar-grid" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                            <div class="avatar-item selected" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/616/616408.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/616/616408.png" title="Nick Wilde"></div>
                            <div class="avatar-item" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/616/616432.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/616/616432.png" title="Judy Hopps"></div>
                            <div class="avatar-item" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/3069/3069172.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/3069/3069172.png" title="Flash"></div>
                            <div class="avatar-item" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/616/616406.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/616/616406.png" title="Chief Bogo"></div>
                            <div class="avatar-item" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/616/616430.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/616/616430.png" title="Bellwether"></div>
                            <div class="avatar-item" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/616/616412.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/616/616412.png" title="Mayor Lionheart"></div>
                            <div class="avatar-item" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/616/616402.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/616/616402.png" title="Clawhauser"></div>
                            <div class="avatar-item" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/616/616429.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/616/616429.png" title="Finnick"></div>
                            <div class="avatar-item" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/616/616410.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/616/616410.png" title="Mr. Big"></div>
                            <div class="avatar-item" onclick="selectAvatar('https://cdn-icons-png.flaticon.com/512/616/616565.png', this)"><img src="https://cdn-icons-png.flaticon.com/512/616/616565.png" title="Gazelle"></div>
                        </div>
                    </div>
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #f1f5f9;">
                        <h4 style="font-size: 14px; margin-bottom: 10px; color: var(--text-main);">ƒê·ªïi m·∫≠t kh·∫©u</h4>
                        <input type="password" id="oldPass" class="input-modern" placeholder="M·∫≠t kh·∫©u hi·ªán t·∫°i">
                        <input type="password" id="newPass" class="input-modern" placeholder="M·∫≠t kh·∫©u m·ªõi (√≠t nh·∫•t 6 k√Ω t·ª±)">
                        <button class="btn btn-primary" onclick="changePassword()" style="background: #64748b; margin-top: 10px; width: 100%;">C·∫≠p nh·∫≠t m·∫≠t kh·∫©u</button>
                    </div>
                    <button class="btn btn-primary" onclick="saveProfile()" data-i18n="btn.save" style="margin-top: 20px;">L∆∞u thay ƒë·ªïi</button>
                    <button class="btn btn-danger" onclick="logout()" data-i18n="btn.logout">ƒêƒÉng xu·∫•t</button>
                </div>
            </div>

            <div id="tab-settings" class="tab-content">
                <div class="card" style="max-width: 650px; margin: 0 auto;">
                    <div class="card-header"><span class="card-title"><i class='bx bx-cog'></i> <span data-i18n="settings.title">C√†i ƒë·∫∑t h·ªá th·ªëng</span></span></div>
                    <div class="setting-section">
                        <div class="setting-title" data-i18n="settings.interface">Giao di·ªán</div>
                        <div class="setting-row">
                            <div class="setting-info"><h4 data-i18n="settings.language">Ng√¥n ng·ªØ</h4><p data-i18n="settings.language_desc">Ch·ªçn ng√¥n ng·ªØ hi·ªÉn th·ªã.</p></div>
                            <select class="form-select" id="langSelect" onchange="changeLanguage(this.value)">
                                <option value="vi">Ti·∫øng Vi·ªát</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info"><h4 data-i18n="settings.dark_mode">Ch·∫ø ƒë·ªô T·ªëi</h4><p data-i18n="settings.dark_mode_desc">Giao di·ªán t·ªëi b·∫£o v·ªá m·∫Øt.</p></div>
                            <label class="switch"><input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()"><span class="slider"></span></label>
                        </div>
                         <div class="setting-row">
                            <div class="setting-info"><h4>Ch·∫ø ƒë·ªô Trong su·ªët</h4><p>L√†m m·ªù giao di·ªán ƒë·ªÉ th·∫•y h√¨nh n·ªÅn.</p></div>
                            <label class="switch"><input type="checkbox" id="transparentToggle" onchange="toggleTransparent()"><span class="slider"></span></label>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info"><h4 data-i18n="settings.wallpaper">H√¨nh n·ªÅn</h4><p data-i18n="settings.wallpaper_desc">T·∫£i ·∫£nh t·ª´ m√°y t√≠nh.</p></div>
                            <div>
                                <label for="bgUpload" class="btn" style="background:var(--primary-light); color:var(--primary); cursor:pointer;">Upload</label>
                                <input type="file" id="bgUpload" hidden onchange="changeBg(event)">
                                <span style="font-size:12px; color:red; cursor:pointer; margin-left:10px;" onclick="resetBg()">[X√≥a]</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <button class="fab-btn" onclick="openAddDeviceModal()" title="Th√™m thi·∫øt b·ªã m·ªõi"><i class='bx bx-plus'></i></button>

    <div id="addDeviceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddDeviceModal()">&times;</span>
            <h3 style="margin-bottom: 20px; color: var(--primary);">Th√™m thi·∫øt b·ªã m·ªõi</h3>
            <label style="font-size: 13px; font-weight: 600;">T√™n thi·∫øt b·ªã:</label>
            <input type="text" id="newDevName" class="input-modern" placeholder="V√≠ d·ª•: ƒê√®n s√¢n v∆∞·ªùn...">
            <label style="font-size: 13px; font-weight: 600; display:block; margin-top:10px;">Lo·∫°i thi·∫øt b·ªã:</label>
            <select id="newDevType" class="form-select" style="width:100%; margin-top:5px;">
                <option value="sensor">C·∫£m bi·∫øn</option>
                <option value="switch">C√¥ng t·∫Øc</option>
            </select>
            <label style="font-size: 13px; font-weight: 600; display:block; margin-top:10px;">MQTT Topic:</label>
            <input type="text" id="newDevTopic" class="input-modern" placeholder="V√≠ d·ª•: home/light1">
            <label style="font-size: 13px; font-weight: 600; display:block; margin-top:10px;">ƒê∆°n v·ªã (n·∫øu l√† c·∫£m bi·∫øn):</label>
            <input type="text" id="newDevUnit" class="input-modern" placeholder="V√≠ d·ª•: ¬∞C, %...">
            <button class="btn btn-primary" onclick="addNewDevice()" style="margin-top: 20px;">L∆∞u thi·∫øt b·ªã</button>
        </div>
    </div>

    <script>
        const mqttHost = "broker.hivemq.com"; 
        const mqttPort = 8884; 
        const mqttTopic = "shadowfox/system_data";
        
        const socket = io(); 
        let client = null;
        let lastPumpState = false; 
        
        let customDevices = []; 

        function loadCustomDevices() {
            const saved = localStorage.getItem('customDevices');
            if (saved) { customDevices = JSON.parse(saved); renderCustomDevices(); }
        }

        function renderCustomDevices() {
            const container = document.getElementById('dynamic-grid');
            container.innerHTML = ''; 

            customDevices.forEach((dev, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                const deleteBtn = `<span style="position:absolute; top:10px; right:10px; cursor:pointer; color:#ef4444;" onclick="removeDevice(${index})"><i class='bx bx-x'></i></span>`;

                if (dev.type === 'sensor') {
                    card.innerHTML = `${deleteBtn}<div class="card-title" style="justify-content: center;">${dev.name}</div><div style="text-align: center; margin: 20px 0;"><div class="stat-value" id="val-${index}" style="color: var(--primary);">--</div><div style="color: var(--secondary); font-size: 14px;">${dev.unit}</div></div><div style="font-size: 11px; color: #9ca3af; text-align: center;">Topic: ${dev.topic}</div>`;
                } else {
                    card.innerHTML = `${deleteBtn}<div class="card-title" style="justify-content: center;">${dev.name}</div><div class="pump-card" id="btn-${index}" onclick="toggleCustomDevice(${index})"><div class="pump-icon"><i class='bx bx-power-off'></i></div><div style="font-weight: 600; margin-top: 10px;" id="txt-${index}">OFF</div></div><div style="font-size: 11px; color: #9ca3af; text-align: center; margin-top: 10px;">Topic: ${dev.topic}</div>`;
                }
                container.appendChild(card);
            });
        }

        function openAddDeviceModal() { document.getElementById('addDeviceModal').style.display = 'block'; }
        function closeAddDeviceModal() { document.getElementById('addDeviceModal').style.display = 'none'; }

        function addNewDevice() {
            const name = document.getElementById('newDevName').value;
            const type = document.getElementById('newDevType').value;
            const topic = document.getElementById('newDevTopic').value;
            const unit = document.getElementById('newDevUnit').value;

            if(!name || !topic) { alert("Vui l√≤ng nh·∫≠p t√™n v√† Topic!"); return; }
            customDevices.push({ name, type, topic, unit, value: 'OFF' });
            localStorage.setItem('customDevices', JSON.stringify(customDevices));
            if(client && client.isConnected()) client.subscribe(topic);
            renderCustomDevices(); closeAddDeviceModal();
        }

        function removeDevice(index) {
            if(confirm("X√≥a thi·∫øt b·ªã n√†y?")) {
                customDevices.splice(index, 1);
                localStorage.setItem('customDevices', JSON.stringify(customDevices));
                renderCustomDevices();
            }
        }

        function toggleCustomDevice(index) {
            const dev = customDevices[index];
            const newState = (dev.value === 'ON') ? 'OFF' : 'ON';
            dev.value = newState;
            const btn = document.getElementById(`btn-${index}`);
            const txt = document.getElementById(`txt-${index}`);
            if(newState === 'ON') { btn.classList.add('active'); txt.innerText = "ON"; } else { btn.classList.remove('active'); txt.innerText = "OFF"; }
            const message = new Paho.MQTT.Message(newState); message.destinationName = dev.topic; client.send(message);
        }
        
        // --- [M·ªöI] H√ÄM CH·ª§P ·∫¢NH TH·ª¶ C√îNG ---
        function triggerSnapshot() {
             if (client && client.isConnected()) {
                 // G·ª≠i tin nh·∫Øn "SNAP" l√™n topic camera
                 const message = new Paho.MQTT.Message("SNAP");
                 message.destinationName = "shadowfox/camera_trigger";
                 client.send(message);
                 
                 // Hi·ªáu ·ª©ng n√∫t b·∫•m
                 alert("üì∏ ƒê√£ g·ª≠i l·ªánh ch·ª•p ·∫£nh!");
                 document.getElementById('camStatusBadge').innerText = "‚óè REQUESTING...";
                 document.getElementById('camStatusBadge').style.background = "#eab308"; // M√†u v√†ng
             } else {
                 alert("L·ªói: Ch∆∞a k·∫øt n·ªëi MQTT!");
             }
        }

        async function fetchWithAuth(url, options = {}) { const token = localStorage.getItem('authToken'); if (!token) { alert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n!"); window.location.href = 'index.html'; return null; } if (!options.headers) options.headers = {}; options.headers['Authorization'] = 'Bearer ' + token; options.headers['Content-Type'] = 'application/json'; try { const res = await fetch(url, options); if (res.status === 401 || res.status === 403) { alert("H·∫øt phi√™n l√†m vi·ªác!"); localStorage.clear(); window.location.href = 'index.html'; return null; } return res; } catch (err) { alert("L·ªói k·∫øt n·ªëi Server!"); return null; } }
        const translations = { vi: { "menu.home": "T·ªïng quan", "menu.camera": "Camera", "menu.logs": "Nh·∫≠t k√Ω", "menu.account": "T√†i kho·∫£n", "menu.settings": "C√†i ƒë·∫∑t", "header.hello": "Xin ch√†o", "iot.disconnected": "Ng·∫Øt k·∫øt n·ªëi", "iot.connected": "ƒê√£ k·∫øt n·ªëi", "chart.title": "Bi·ªÉu ƒë·ªì m·ª±c n∆∞·ªõc", "gauge.title": "M·ª±c n∆∞·ªõc hi·ªán t·∫°i", "status.waiting": "ƒêang ƒë·ª£i d·ªØ li·ªáu...", "status.safe": "H·ªá th·ªëng an to√†n", "status.danger": "C·∫¢NH B√ÅO NG·∫¨P!", "controls.title": "ƒêi·ªÅu khi·ªÉn", "pump.name": "M√°y B∆°m", "pump.on": "ƒêang Ho·∫°t ƒê·ªông", "pump.off": "ƒêang T·∫Øt", "siren.label": "Tr·∫°ng th√°i C√≤i h√∫:", "logs.title": "Nh·∫≠t k√Ω ho·∫°t ƒë·ªông", "table.time": "Th·ªùi gian", "table.event": "S·ª± ki·ªán", "table.detail": "Chi ti·∫øt", "table.status": "Tr·∫°ng th√°i", "account.title": "Th√¥ng tin t√†i kho·∫£n", "account.choose_avatar": "Ch·ªçn nh√¢n v·∫≠t ƒë·∫°i di·ªán:", "settings.title": "C√†i ƒë·∫∑t h·ªá th·ªëng", "settings.interface": "Giao di·ªán", "settings.language": "Ng√¥n ng·ªØ", "settings.language_desc": "Ch·ªçn ng√¥n ng·ªØ hi·ªÉn th·ªã.", "settings.dark_mode": "Ch·∫ø ƒë·ªô T·ªëi", "settings.dark_mode_desc": "Giao di·ªán t·ªëi b·∫£o v·ªá m·∫Øt.", "settings.wallpaper": "H√¨nh n·ªÅn", "settings.wallpaper_desc": "T·∫£i ·∫£nh t·ª´ m√°y t√≠nh.", "btn.save": "L∆∞u thay ƒë·ªïi", "btn.logout": "ƒêƒÉng xu·∫•t" }, en: { "menu.home": "Overview", "menu.camera": "Camera", "menu.logs": "Logs", "menu.account": "Account", "menu.settings": "Settings", "header.hello": "Hello", "iot.disconnected": "Disconnected", "iot.connected": "Connected", "chart.title": "Water Level Chart", "gauge.title": "Current Level", "status.waiting": "Waiting for data...", "status.safe": "System Safe", "status.danger": "FLOOD ALERT!", "controls.title": "Controls", "pump.name": "Water Pump", "pump.on": "Running", "pump.off": "Stopped", "siren.label": "Siren Status:", "logs.title": "Activity Logs", "table.time": "Time", "table.event": "Event", "table.detail": "Detail", "table.status": "Status", "account.title": "Account Info", "account.choose_avatar": "Choose Avatar:", "settings.title": "System Settings", "settings.interface": "Interface", "settings.language": "Language", "settings.language_desc": "Select display language.", "settings.dark_mode": "Dark Mode", "settings.dark_mode_desc": "Switch to dark theme.", "settings.wallpaper": "Wallpaper", "settings.wallpaper_desc": "Upload image.", "btn.save": "Save Changes", "btn.logout": "Logout" } };
        let currentLang = localStorage.getItem('lang') || 'vi';
        const currentUser = localStorage.getItem('currentUser') || "Guest"; 
        let userRole = localStorage.getItem('userRole') || 'viewer';
        if (currentUser === 'Mikeyiy') userRole = 'admin';

        function addLogRecord(event, detail, statusText, statusClass) { const tbody = document.getElementById('logBody'); const row = document.createElement('tr'); const time = new Date().toLocaleTimeString('vi-VN'); row.innerHTML = `<td>${time}</td><td style="font-weight: 600;">${event}</td><td>${detail}</td><td><span class="tag ${statusClass}">${statusText}</span></td>`; tbody.insertBefore(row, tbody.firstChild); if(tbody.children.length > 50) tbody.removeChild(tbody.lastChild); }

        function init() {
            document.getElementById('sidebarName').innerText = currentUser; document.getElementById('headerName').innerText = currentUser; document.getElementById('sidebarRole').innerText = userRole.toUpperCase(); document.getElementById('previewName').innerText = currentUser; document.getElementById('previewRole').innerText = userRole.toUpperCase(); let currentAvatar = localStorage.getItem('currentAvatar') || "https://cdn-icons-png.flaticon.com/512/616/616408.png"; document.getElementById('sidebarAvatar').src = currentAvatar; document.getElementById('previewAvatar').src = currentAvatar;
            const pumpBtn = document.getElementById('btnPump'); const adminMenu = document.getElementById('menuAdmin'); if (userRole === 'admin') { pumpBtn.style.opacity = '1'; pumpBtn.style.cursor = 'pointer'; if (currentUser === 'Mikeyiy') { if(adminMenu) adminMenu.style.display = 'flex'; } else { if(adminMenu) adminMenu.style.display = 'none'; } } else { pumpBtn.style.opacity = '0.5'; pumpBtn.style.cursor = 'not-allowed'; pumpBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); alert("‚õî CH·ªà XEM: B·∫°n kh√¥ng c√≥ quy·ªÅn ƒëi·ªÅu khi·ªÉn!"); }; document.getElementById('pumpText').innerText = "CH·ªà XEM (VIEW ONLY)"; if(adminMenu) adminMenu.style.display = 'none'; }
            document.getElementById('langSelect').value = currentLang; changeLanguage(currentLang); 
            if(localStorage.getItem('darkMode') === 'true') { document.body.classList.add('dark-mode'); document.getElementById('darkModeToggle').checked = true; }
            if(localStorage.getItem('transparentMode') === 'true') { document.body.classList.add('transparent-ui'); document.getElementById('transparentToggle').checked = true; }
            const savedBg = localStorage.getItem('modern_bg'); if(savedBg) document.body.style.backgroundImage = `url('${savedBg}')`;

            loadCustomDevices();

            socket.on('new_snapshot', function(data) {
                console.log("üì∏ C√≥ ·∫£nh m·ªõi!", data);
                // 1. Thay ƒë·ªïi n·ªôi dung c·ªßa Badge
                const badge = document.getElementById('camStatusBadge');
                badge.innerText = "üì∏ ·∫¢NH M·ªöI";
                badge.className = "live-badge alert"; 

                // 2. C·∫≠p nh·∫≠t ·∫£nh
                const img = document.getElementById('eventImage');
                img.src = data.url + "?t=" + new Date().getTime();
                
                // 3. C·∫≠p nh·∫≠t gi·ªù
                document.getElementById('eventTime').innerText = "Ch·ª•p l√∫c: " + data.time;
                
                addLogRecord("üì∏ ƒê√É CH·ª§P ·∫¢NH", "Camera g·ª≠i ·∫£nh v·ªÅ Server", "Th√†nh c√¥ng", "ok");
            });

            connectMQTT();
            updateTime(); setInterval(updateTime, 1000);
        }

        function changeLanguage(lang) { currentLang = lang; localStorage.setItem('lang', lang); const elements = document.querySelectorAll('[data-i18n]'); elements.forEach(el => { const key = el.getAttribute('data-i18n'); if (translations[lang][key]) el.innerText = translations[lang][key]; }); }
        function toggleDarkMode() { const d = document.getElementById('darkModeToggle').checked; if(d) document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode'); localStorage.setItem('darkMode', d); }
        function toggleTransparent() { const isTransparent = document.getElementById('transparentToggle').checked; if (isTransparent) document.body.classList.add('transparent-ui'); else document.body.classList.remove('transparent-ui'); localStorage.setItem('transparentMode', isTransparent); }
        function changeBg(e) { const file = e.target.files[0]; if(file){ const reader = new FileReader(); reader.onload = (evt) => { const bgData = evt.target.result; document.body.style.backgroundImage = `url('${bgData}')`; localStorage.setItem('modern_bg', bgData); }; reader.readAsDataURL(file); } }
        function resetBg() { localStorage.removeItem('modern_bg'); document.body.style.backgroundImage = "url('https://images.unsplash.com/photo-1493246507139-91e8fad9978e?q=80&w=2670&auto=format&fit=crop')"; }
        
        async function togglePump() { if (userRole !== 'admin') return; const isCurrentlyOn = document.getElementById('btnPump').classList.contains('active'); const action = isCurrentlyOn ? 'OFF' : 'ON'; document.getElementById('pumpText').innerText = "ƒêang g·ª≠i..."; const res = await fetchWithAuth('/api/control-pump', { method: 'POST', body: JSON.stringify({ action }) }); if (res) { const data = await res.json(); if(data.success) console.log("Sent:", action); else alert("L·ªói: " + data.message); } }
        async function changePassword() { const oldPass = document.getElementById('oldPass').value; const newPass = document.getElementById('newPass').value; if (!oldPass || !newPass) { alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!"); return; } if (newPass.length < 6) { alert("M·∫≠t kh·∫©u m·ªõi qu√° ng·∫Øn!"); return; } const res = await fetchWithAuth('/api/change-password', { method: 'POST', body: JSON.stringify({ oldPassword: oldPass, newPassword: newPass }) }); if (res) { const d = await res.json(); alert(d.message); if(d.success) { document.getElementById('oldPass').value = ''; document.getElementById('newPass').value = ''; } } }
        async function loadUserList() { if (currentUser !== 'Mikeyiy') return; const tbody = document.getElementById('userListBody'); tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>'; const res = await fetchWithAuth('/api/list-users', { method: 'POST' }); if (res) { const data = await res.json(); tbody.innerHTML = ''; if (data.success) { data.users.forEach(u => { let actionHtml = ''; if (u.username === 'Mikeyiy') { actionHtml = '<span class="tag ok" style="background:#4f46e5; color:white;">SUPER ADMIN</span>'; } else { let roleBtn = ''; if (u.role === 'admin') roleBtn = `<button class="btn" style="background:#f59e0b; color:white; padding:5px 10px; font-size:12px; margin:0;" onclick="changeRole('${u.username}', 'viewer')">Xu·ªëng Viewer</button>`; else roleBtn = `<button class="btn btn-primary" style="background:#4f46e5; padding:5px 10px; font-size:12px; margin:0;" onclick="changeRole('${u.username}', 'admin')">L√™n Admin</button>`; const deleteBtn = `<button class="btn" style="background:#ef4444; color:white; padding:5px 10px; font-size:12px; margin:0; margin-left:5px;" onclick="deleteUser('${u.username}')"><i class='bx bx-trash'></i> X√≥a</button>`; actionHtml = `<div style="display:flex;">${roleBtn} ${deleteBtn}</div>`; } tbody.insertAdjacentHTML('beforeend', `<tr><td><b>${u.username}</b></td><td>${u.email}</td><td><span class="tag ${u.role==='admin'?'ok':'warn'}">${u.role}</span></td><td>${actionHtml}</td></tr>`); }); } } }
        async function changeRole(target, newRole) { if(!confirm(`ƒê·ªïi quy·ªÅn ${target}?`)) return; await fetchWithAuth('/api/set-user-role', { method: 'POST', body: JSON.stringify({ targetUser: target, newRole: newRole }) }); loadUserList(); }
        async function deleteUser(target) { if (!confirm(`X√≥a ${target}?`)) return; const res = await fetchWithAuth('/api/delete-user', { method: 'POST', body: JSON.stringify({ targetUser: target }) }); if (res) { const data = await res.json(); alert(data.message); if (data.success) loadUserList(); } }
        function switchTab(id, el) { document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); document.getElementById('tab-'+id).classList.add('active'); if(el) { document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active')); el.classList.add('active'); } }
        function logout() { if(confirm("ƒêƒÉng xu·∫•t?")) { localStorage.clear(); window.location.href='index.html'; } }
        function saveProfile() { location.reload(); }
        function selectAvatar(u, e) { localStorage.setItem('currentAvatar', u); document.querySelectorAll('.avatar-item').forEach(i=>i.classList.remove('selected')); e.classList.add('selected'); document.getElementById('previewAvatar').src=u; }
        function updateTime() { const now = new Date(); document.getElementById('clockDisplay').innerText = now.toLocaleTimeString(currentLang==='vi'?'vi-VN':'en-US',{hour12:false}); }

        function connectMQTT() {
            const clientId = "web-" + Math.random().toString(16).substr(2, 8);
            client = new Paho.MQTT.Client(mqttHost, mqttPort, clientId);
            
            client.onMessageArrived = (msg) => {
                const topic = msg.destinationName;
                const payload = msg.payloadString;

                if (topic === mqttTopic) {
                    try { 
                        const data = JSON.parse(payload);
                        const MAX_DEPTH = 10.2; 
                        let depthCM = (data.waterLevel / 100) * MAX_DEPTH;
                        depthCM = parseFloat(depthCM.toFixed(1)); 

                        if (data.isPumpOn === true && lastPumpState === false) addLogRecord("‚ö†Ô∏è C·∫¢NH B√ÅO NG·∫¨P", `ƒê·ªô s√¢u ƒëo ƒë∆∞·ª£c: ${depthCM} cm`, "B∆°m ƒê√É B·∫¨T", "warn");
                        else if (data.isPumpOn === false && lastPumpState === true) addLogRecord("‚úÖ ƒê√£ x·ª≠ l√Ω xong", `ƒê·ªô s√¢u gi·∫£m c√≤n: ${depthCM} cm`, "B∆°m ƒê√É T·∫ÆT", "ok");
                        lastPumpState = data.isPumpOn;

                        document.getElementById('waterLevelText').innerHTML = depthCM + " cm <div style='font-size:16px; color:#9ca3af; margin-top:5px;'>(" + data.waterLevel + "%)</div>";
                        gaugeChart.updateSeries([data.waterLevel]);
                        const now = new Date().toLocaleTimeString();
                        lineChart.appendData([{ data: [{ x: now, y: depthCM }] }]);

                        const btn = document.getElementById('btnPump'); const txtPump = document.getElementById('pumpText');
                        if(data.isPumpOn) { btn.classList.add('active'); if(userRole === 'admin') txtPump.innerText = "ƒêANG CH·∫†Y"; } 
                        else { btn.classList.remove('active'); if(userRole === 'admin') txtPump.innerText = "ƒêANG T·∫ÆT"; }

                        const alertBox = document.getElementById('statusAlert'); const sirenTxt = document.getElementById('sirenText');
                        if (data.isSirenOn) { alertBox.className = 'alert-box danger'; alertBox.innerHTML = "<i class='bx bxs-bell-ring bx-tada'></i> C·∫¢NH B√ÅO NG·∫¨P!"; sirenTxt.innerText = "ƒêANG K√äU üîä"; sirenTxt.style.color = "#ef4444"; sirenTxt.style.fontWeight = "bold"; } 
                        else { alertBox.className = 'alert-box'; alertBox.innerHTML = "<i class='bx bx-shield-quarter'></i> H·ªá th·ªëng an to√†n"; sirenTxt.innerText = "Im l·∫∑ng"; sirenTxt.style.color = "var(--secondary)"; }
                    } catch(e){ console.error("L·ªói MQTT:", e); }
                }

                // [M·ªöI] T·ª± ƒë·ªông ghi log khi thi·∫øt b·ªã m·ªü r·ªông b·∫≠t/t·∫Øt
                customDevices.forEach((dev, index) => {
                    if (dev.topic === topic) {
                        if (dev.type === 'sensor') { document.getElementById(`val-${index}`).innerText = payload; } 
                        else if (dev.type === 'switch') { 
                            // N·∫øu tr·∫°ng th√°i thay ƒë·ªïi th√¨ ghi log
                            if (dev.value !== payload) {
                                addLogRecord("‚ö° THI·∫æT B·ªä M·ªû R·ªòNG", `${dev.name} ƒë√£ chuy·ªÉn sang ${payload}`, "OK", "ok");
                            }
                            dev.value = payload; 
                            const btn = document.getElementById(`btn-${index}`); 
                            const txt = document.getElementById(`txt-${index}`); 
                            if(payload === 'ON') { btn.classList.add('active'); txt.innerText = "ON"; } else { btn.classList.remove('active'); txt.innerText = "OFF"; } 
                        }
                    }
                });
            };

            client.connect({ onSuccess: () => { client.subscribe(mqttTopic); customDevices.forEach(dev => { client.subscribe(dev.topic); }); document.getElementById('mqttStatus').className = 'iot-status connected'; document.getElementById('mqttText').innerText="ƒê√£ k·∫øt n·ªëi"; }, onFailure: (e) => { console.log("L·ªói:", e); document.getElementById('mqttText').innerText="L·ªói k·∫øt n·ªëi"; }, useSSL: true }); 
        }

        var lineChart = new ApexCharts(document.querySelector("#lineChart"), { series: [{name:'ƒê·ªô s√¢u (cm)',data:[]}], chart: {type:'area',height:250,toolbar:{show:false}, animations: {enabled: true, easing: 'linear', dynamicAnimation: {speed: 1000}}}, stroke:{curve:'smooth'}, xaxis: { type: 'category', range: 10 } }); lineChart.render();
        var gaugeChart = new ApexCharts(document.querySelector("#gaugeChart"), { series: [0], chart: {type:'radialBar',height:250}, plotOptions:{radialBar:{hollow:{size:'60%'}}} }); gaugeChart.render();

        async function exportData() { const btn = event.target; const originalText = btn.innerText; btn.innerText = "ƒêang t·∫£i..."; btn.disabled = true; try { const res = await fetchWithAuth('/api/sensor-history', { method: 'POST' }); if (!res) return; const responseData = await res.json(); if (!responseData.success) { alert("L·ªói: " + responseData.message); return; } const dataList = responseData.data; if (!dataList || dataList.length === 0) { alert("Ch∆∞a c√≥ d·ªØ li·ªáu!"); return; } let fileContent = ""; let fileName = `Log_${new Date().getTime()}`; let mimeType = ""; const type = prompt("Nh·∫≠p 'csv' ho·∫∑c 'txt':", "csv"); if (type === 'csv') { fileContent = "\uFEFFTh·ªùi gian,M·ª±c n∆∞·ªõc (%),B∆°m,C√≤i\n"; dataList.forEach(item => { const time = new Date(item.timestamp).toLocaleString('vi-VN'); fileContent += `"${time}",${item.waterLevel},${item.isPumpOn?'ON':'OFF'},${item.isSirenOn?'ON':'OFF'}\n`; }); fileName += ".csv"; mimeType = "text/csv;charset=utf-8;"; } else { fileContent = "NH·∫¨T K√ù\n"; dataList.forEach(item => { const time = new Date(item.timestamp).toLocaleString('vi-VN'); fileContent += `[${time}] Level: ${item.waterLevel}%\n`; }); fileName += ".txt"; mimeType = "text/plain;charset=utf-8;"; } const blob = new Blob([fileContent], { type: mimeType }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = fileName; link.style.display = "none"; document.body.appendChild(link); link.click(); document.body.removeChild(link); alert("ƒê√£ xu·∫•t file!"); } catch (e) { console.error(e); alert("L·ªói!"); } finally { btn.innerText = originalText; btn.disabled = false; } }

        init();
    </script>
</body>
</html>